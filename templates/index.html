<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>True News - Правдивые новости вашего города</title>
    <style>
        :root {
            /* Light theme colors */
            --primary-color: #2563eb;
            --secondary-color: #64748b;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --light-bg: #f8fafc;
            --white: #ffffff;
            --dark-text: #1e293b;
            --light-text: #64748b;
            --border-color: #e2e8f0;
            
            /* Dark theme colors */
            --dark-bg: #000000;
            --dark-surface: #1a0000;
            --dark-red: #dc2626;
            --dark-red-light: #ef4444;
            --dark-text-primary: #ffffff;
            --dark-text-secondary: #dc2626;
            --dark-border: #450000;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--dark-text);
            background: var(--light-bg);
            transition: all 0.3s ease;
        }

        /* Light theme styles */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        header {
            background: var(--white);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
        }

        .logo {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
            text-decoration: none;
        }

        .nav-menu {
            display: flex;
            list-style: none;
            gap: 2rem;
        }

        .nav-menu a {
            color: var(--dark-text);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s ease;
        }

        .nav-menu a:hover {
            color: var(--primary-color);
        }

        .auth-buttons {
            display: flex;
            gap: 1rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: #1d4ed8;
        }

        .btn-secondary {
            background: transparent;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }

        .btn-secondary:hover {
            background: var(--primary-color);
            color: white;
        }

        .hero {
            background: linear-gradient(135deg, var(--primary-color), #1e40af);
            color: white;
            padding: 4rem 0;
            text-align: center;
        }

        .hero h1 {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .hero p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .main-content {
            padding: 3rem 0;
        }

        .news-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .news-card {
            background: var(--white);
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: transform 0.3s ease;
        }

        .news-card:hover {
            transform: translateY(-5px);
        }

        .news-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .news-content {
            padding: 1.5rem;
        }

        .news-meta {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            color: var(--light-text);
        }

        .news-category {
            background: var(--primary-color);
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 3px;
            font-size: 0.8rem;
        }

        .news-card h3 {
            margin-bottom: 1rem;
            color: var(--dark-text);
        }

        .news-preview {
            color: var(--light-text);
            margin-bottom: 1rem;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: var(--white);
            margin: 50px auto;
            padding: 2rem;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            position: relative;
            animation: slideIn 0.3s ease;
        }

        .close {
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 2rem;
            cursor: pointer;
            color: var(--light-text);
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 1rem;
        }

        /* Dark Web Styles */
        .dark-theme {
            background: var(--dark-bg);
            color: var(--dark-text-primary);
            min-height: 100vh;
        }

        .dark-verification {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: var(--dark-bg);
            color: var(--dark-text-primary);
        }

        .verification-box {
            background: var(--dark-surface);
            padding: 3rem;
            border-radius: 10px;
            border: 2px solid var(--dark-red);
            text-align: center;
            box-shadow: 0 0 30px rgba(220, 38, 38, 0.3);
        }

        .verification-box h2 {
            color: var(--dark-red);
            margin-bottom: 2rem;
            font-size: 1.5rem;
        }

        .code-input {
            background: var(--dark-bg);
            color: var(--dark-text-primary);
            border: 1px solid var(--dark-red);
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 5px;
            font-size: 1.2rem;
            text-align: center;
            letter-spacing: 0.5rem;
        }

        .btn-dark {
            background: var(--dark-red);
            color: white;
            border: none;
            padding: 0.75rem 2rem;
            margin: 1rem 0;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .btn-dark:hover {
            background: var(--dark-red-light);
        }

        .dark-market {
            background: var(--dark-bg);
            color: var(--dark-text-primary);
            min-height: 100vh;
        }

        .dark-header {
            background: var(--dark-surface);
            border-bottom: 2px solid var(--dark-red);
            padding: 1rem 0;
        }

        .dark-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dark-logo {
            color: var(--dark-red);
            font-size: 1.5rem;
            font-weight: bold;
        }

        .dark-user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .balance {
            color: var(--dark-red);
            font-weight: bold;
        }

        .market-content {
            padding: 2rem;
        }

        .market-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 1px solid var(--dark-border);
        }

        .tab {
            padding: 1rem 2rem;
            background: transparent;
            color: var(--dark-text-primary);
            border: none;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .tab.active {
            color: var(--dark-red);
            border-bottom-color: var(--dark-red);
        }

        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .item-card {
            background: var(--dark-surface);
            border: 1px solid var(--dark-border);
            border-radius: 10px;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }

        .item-card:hover {
            border-color: var(--dark-red);
            box-shadow: 0 0 20px rgba(220, 38, 38, 0.2);
        }

        .item-name {
            color: var(--dark-red);
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .item-price {
            color: var(--dark-text-primary);
            font-size: 1.5rem;
            font-weight: bold;
            margin: 1rem 0;
        }

        .seller-info {
            display: flex;
            justify-content: space-between;
            margin: 1rem 0;
            font-size: 0.9rem;
            color: var(--light-text);
        }

        .rating {
            color: var(--warning-color);
        }

        /* Gang System */
        .gangs-section {
            margin-top: 3rem;
        }

        .gang-card {
            background: var(--dark-surface);
            border: 1px solid var(--dark-border);
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .gang-name {
            color: var(--dark-red);
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }

        .gang-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            color: var(--dark-red);
            font-size: 1.5rem;
            font-weight: bold;
        }

        .stat-label {
            color: var(--light-text);
            font-size: 0.9rem;
        }

        /* Chat */
        .chat-container {
            background: var(--dark-surface);
            border: 1px solid var(--dark-border);
            border-radius: 10px;
            height: 400px;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
        }

        .message {
            margin-bottom: 1rem;
            padding: 0.5rem;
            background: var(--dark-bg);
            border-radius: 5px;
        }

        .message-author {
            color: var(--dark-red);
            font-weight: bold;
            font-size: 0.9rem;
        }

        .message-text {
            margin-top: 0.25rem;
        }

        .chat-input {
            display: flex;
            padding: 1rem;
            border-top: 1px solid var(--dark-border);
        }

        .chat-input input {
            flex: 1;
            background: var(--dark-bg);
            color: var(--dark-text-primary);
            border: 1px solid var(--dark-border);
            padding: 0.5rem;
            border-radius: 5px;
            margin-right: 1rem;
        }

        /* Freeze effect */
        .freeze {
            pointer-events: none;
            opacity: 0.7;
            filter: blur(1px);
        }

        /* Glitch effect */
        .glitch {
            animation: glitch 0.3s ease-in-out;
        }

        @keyframes glitch {
            0% { transform: translate(0); }
            20% { transform: translate(-2px, 2px); }
            40% { transform: translate(-2px, -2px); }
            60% { transform: translate(2px, 2px); }
            80% { transform: translate(2px, -2px); }
            100% { transform: translate(0); }
        }

        /* Matrix Effect */
        .matrix-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--dark-bg);
            z-index: -1;
            overflow: hidden;
        }

        .matrix-column {
            position: absolute;
            top: -100px;
            font-family: monospace;
            font-size: 12px;
            color: var(--dark-red);
            opacity: 0.8;
            animation: matrixFall linear infinite;
        }

        @keyframes matrixFall {
            0% { transform: translateY(-100px); }
            100% { transform: translateY(100vh); }
        }

        /* Loading Animation */
        .loading-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: var(--dark-bg);
            color: var(--dark-text-primary);
        }

        .loading-text {
            font-size: 1.5rem;
            color: var(--dark-red);
            margin-bottom: 2rem;
            animation: pulse 1s ease-in-out infinite;
        }

        .progress-bar {
            width: 300px;
            height: 20px;
            background: var(--dark-surface);
            border: 2px solid var(--dark-red);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--dark-red), var(--dark-red-light));
            width: 0%;
            transition: width 0.3s ease;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Admin Panel */
        .admin-panel {
            background: var(--dark-surface);
            border: 2px solid var(--dark-red);
            border-radius: 10px;
            padding: 2rem;
            margin: 2rem 0;
            box-shadow: 0 0 30px rgba(220, 38, 38, 0.3);
        }

        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }

        .admin-stat-card {
            background: var(--dark-bg);
            border: 1px solid var(--dark-red);
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
        }

        .admin-stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--dark-red);
        }

        .admin-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 2rem;
        }

        .admin-section {
            background: var(--dark-bg);
            border: 1px solid var(--dark-border);
            border-radius: 8px;
            padding: 1.5rem;
        }

        .delete-btn {
            background: var(--danger-color-dark, #dc2626);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .delete-btn:hover {
            background: var(--dark-red-light);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .hidden {
            display: none !important;
        }

        /* Correspondent Panel */
        .correspondent-panel {
            background: var(--white);
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin: 2rem 0;
        }

        .correspondent-panel h3 {
            color: var(--primary-color);
            margin-bottom: 1.5rem;
        }

        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 1rem;
            min-height: 120px;
            resize: vertical;
        }

        /* Services section */
        .services-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin: 2rem 0;
        }

        .service-card {
            background: var(--white);
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            padding: 2rem;
            text-align: center;
        }

        .service-price {
            color: var(--primary-color);
            font-size: 1.5rem;
            font-weight: bold;
            margin: 1rem 0;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .nav-menu {
                display: none;
            }
            
            .hero h1 {
                font-size: 2rem;
            }
            
            .news-grid {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                margin: 20px;
                width: calc(100% - 40px);
            }
        }
    </style>
</head>
<body>
    <!-- Main Site -->
    <div id="mainSite">
        <header>
            <div class="container">
                <div class="header-content">
                    <a href="#" class="logo">True News</a>
                    <nav>
                        <ul class="nav-menu">
                            <li><a href="#" onclick="showSection('home')">🏠 Главная</a></li>
                            <li><a href="#" onclick="showSection('about')">ℹ️ О нас</a></li>
                            <li><a href="#" onclick="showSection('services')">⚖️ Услуги адвоката</a></li>
                        </ul>
                    </nav>
                    <div class="auth-buttons">
                        <div id="authButtons">
                            <a href="#" class="btn btn-secondary" onclick="showLogin()">Вход</a>
                            <a href="#" class="btn btn-primary" onclick="showRegister()">Регистрация</a>
                        </div>
                        <div id="userInfo" class="hidden">
                            <span id="userName"></span>
                            <a href="#" class="btn btn-secondary" onclick="logout()">Выход</a>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Home Section -->
        <section id="homeSection">
            <div class="hero">
                <div class="container">
                    <h1>True News</h1>
                    <p>Правдивые новости вашего города</p>
                </div>
            </div>

            <main class="main-content">
                <div class="container">
                    <div id="correspondentPanel" class="correspondent-panel hidden">
                        <h3>📝 Панель корреспондента</h3>
                        <div class="form-group">
                            <label>Заголовок новости:</label>
                            <input type="text" id="newsTitle" placeholder="Введите заголовок">
                        </div>
                        <div class="form-group">
                            <label>Категория:</label>
                            <select id="newsCategory">
                                <option value="Происшествия">Происшествия</option>
                                <option value="Политика">Политика</option>
                                <option value="Экономика">Экономика</option>
                                <option value="Спорт">Спорт</option>
                                <option value="Культура">Культура</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Краткое описание:</label>
                            <textarea id="newsPreview" placeholder="Краткое описание новости"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Полный текст:</label>
                            <textarea id="newsContent" placeholder="Полный текст новости"></textarea>
                        </div>
                        <button class="btn btn-primary" onclick="publishNews()">📰 Опубликовать новость</button>
                    </div>

                    <h2>🔥 Последние новости</h2>
                    
                    <!-- News Filters -->
                    <div style="background: white; padding: 1.5rem; border-radius: 10px; margin: 1rem 0;">
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
                            <input type="text" id="newsSearch" placeholder="🔍 Поиск по заголовку..." style="flex: 1; min-width: 200px; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 5px;" oninput="filterNews()">
                            <select id="categoryFilter" style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 5px;" onchange="filterNews()">
                                <option value="all">Все категории</option>
                                <option value="Политика">Политика</option>
                                <option value="Экономика">Экономика</option>
                                <option value="Спорт">Спорт</option>
                                <option value="Происшествия">Происшествия</option>
                                <option value="Технологии">Технологии</option>
                            </select>
                            <select id="sortOrder" style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 5px;" onchange="filterNews()">
                                <option value="new">Новые</option>
                                <option value="popular">Популярные</option>
                                <option value="views">По просмотрам</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="news-grid" id="newsGrid">
                        <!-- News will be dynamically loaded here -->
                    </div>
                </div>
            </main>
        </section>

        <!-- About Section -->
        <section id="aboutSection" class="hidden">
            <div class="container" style="padding: 3rem 0;">
                <h2>О нас</h2>
                <div style="background: white; padding: 2rem; border-radius: 10px; margin: 2rem 0;">
                    <p>True News - это современный новостной портал, который стремится предоставлять только проверенную и актуальную информацию. Мы работаем 24/7, чтобы держать вас в курсе всех важных событий.</p>
                    <br>
                    <p>Наша команда состоит из опытных журналистов и корреспондентов, которые тщательно проверяют каждую новость перед публикацией.</p>
                    <br>
                    <p>Кроме новостей, мы также предоставляем юридические услуги через нашу партнерскую сеть квалифицированных адвокатов.</p>
                </div>
            </div>
        </section>

        <!-- Services Section -->
        <section id="servicesSection" class="hidden">
            <div class="container" style="padding: 3rem 0;">
                <h2>⚖️ Услуги адвоката</h2>
                <div class="services-grid" id="servicesGrid">
                    <!-- Services will be dynamically loaded here -->
                </div>
            </div>
        </section>
    </div>

    <!-- Dark Web Loading -->
    <div id="darkLoading" class="loading-screen hidden">
        <div class="matrix-bg" id="matrixBg"></div>
        <div class="loading-text" id="loadingText">CONNECTING TO DARK NET...</div>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        <div style="color: #666; font-size: 0.9rem;">⚠️ Это ролевая игра</div>
    </div>

    <!-- Dark Web Verification Step 1 -->
    <div id="darkVerification1" class="dark-verification hidden">
        <div class="verification-box">
            <h2>🔒 СИСТЕМА ВЕРИФИКАЦИИ - ШАГ 1/3</h2>
            <p>Введите код доступа:</p>
            <input type="text" class="code-input" id="verificationCode" placeholder="_ _ _ _" maxlength="3">
            <br>
            <button class="btn-dark" onclick="verifyStep1()">ПОДТВЕРДИТЬ</button>
            <p style="color: #666; margin-top: 1rem; font-size: 0.9rem;">⚠️ Это ролевая игра, не имеющая отношения к реальности</p>
        </div>
    </div>

    <!-- Dark Web Verification Step 2 -->
    <div id="darkVerification2" class="dark-verification hidden">
        <div class="verification-box">
            <h2>🔗 СИСТЕМА ВЕРИФИКАЦИИ - ШАГ 2/3</h2>
            <p>Введите одноразовую ссылку от знакомого:</p>
            <input type="text" class="code-input" id="inviteLink" placeholder="https://invite.to/..." style="font-size: 0.9rem; letter-spacing: normal;">
            <br>
            <button class="btn-dark" onclick="verifyStep2()">ПРОВЕРИТЬ ССЫЛКУ</button>
        </div>
    </div>

    <!-- Dark Web Verification Step 3 -->
    <div id="darkVerification3" class="dark-verification hidden">
        <div class="verification-box">
            <h2>👤 ВХОД НА ПЛОЩАДКУ - ШАГ 3/3</h2>
            <div class="form-group">
                <label style="color: var(--dark-red);">Логин:</label>
                <input type="text" id="darkUsername" class="code-input" placeholder="Введите логин" style="letter-spacing: normal;">
            </div>
            <div class="form-group">
                <label style="color: var(--dark-red);">Пароль:</label>
                <input type="password" id="darkPassword" class="code-input" placeholder="Введите пароль" style="letter-spacing: normal;">
            </div>
            <button class="btn-dark" onclick="verifyStep3()">ВОЙТИ</button>
            <button class="btn-dark" onclick="showDarkRegister()" style="background: var(--dark-surface); margin-left: 1rem;">РЕГИСТРАЦИЯ</button>
        </div>
    </div>

    <!-- Dark Market -->
    <div id="darkMarket" class="dark-market hidden">
        <header class="dark-header">
            <div class="container">
                <div class="dark-nav">
                    <div class="dark-logo">🕷️ DARK MARKET</div>
                    <div class="dark-user-info">
                        <span class="balance">💰 <span id="userBalance">50000</span> ₽</span>
                        <button class="btn-dark" onclick="exitDarkMarket()">ВЫХОД</button>
                    </div>
                </div>
            </div>
        </header>

        <div class="container market-content">
            <!-- Market Search & Filter -->
            <div style="background: var(--dark-surface); padding: 1rem; border-radius: 10px; margin-bottom: 1rem;">
                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                    <input type="text" id="marketSearch" placeholder="🔍 Поиск товаров..." style="flex: 1; min-width: 200px; padding: 0.5rem; background: var(--dark-bg); color: white; border: 1px solid var(--dark-border); border-radius: 5px;" oninput="filterMarketItems()">
                    <select id="marketCategory" style="padding: 0.5rem; background: var(--dark-bg); color: white; border: 1px solid var(--dark-border); border-radius: 5px;" onchange="filterMarketItems()">
                        <option value="all">Все категории</option>
                        <option value="Оружие">Оружие</option>
                        <option value="Документы">Документы</option>
                        <option value="Фармацевтика">Фармацевтика</option>
                        <option value="Взрывчатые вещества">Взрывчатые вещества</option>
                        <option value="Другое">Другое</option>
                    </select>
                    <input type="number" id="priceMin" placeholder="Мин. цена" style="width: 120px; padding: 0.5rem; background: var(--dark-bg); color: white; border: 1px solid var(--dark-border); border-radius: 5px;" oninput="filterMarketItems()">
                    <input type="number" id="priceMax" placeholder="Макс. цена" style="width: 120px; padding: 0.5rem; background: var(--dark-bg); color: white; border: 1px solid var(--dark-border); border-radius: 5px;" oninput="filterMarketItems()">
                    <select id="marketSort" style="padding: 0.5rem; background: var(--dark-bg); color: white; border: 1px solid var(--dark-border); border-radius: 5px;" onchange="filterMarketItems()">
                        <option value="new">Новые</option>
                        <option value="cheap">Дешевые</option>
                        <option value="expensive">Дорогие</option>
                        <option value="popular">Популярные</option>
                    </select>
                </div>
            </div>
            
            <div class="market-tabs">
                <button class="tab active" onclick="showMarketTab('items')">🛒 МАГАЗИН</button>
                <button class="tab" onclick="showMarketTab('gangs')">👥 ГРУППИРОВКИ</button>
                <button class="tab" onclick="showMarketTab('chat')">💬 ЧАТ</button>
                <button class="tab" onclick="showMarketTab('myItems')">📦 МОИ ТОВАРЫ</button>
                <button class="tab" onclick="showMarketTab('profile')">👤 ПРОФИЛЬ</button>
                <button class="tab" onclick="showMarketTab('escrow')">🔒 ЭСКРОУ</button>
                <button class="tab" onclick="showMarketTab('wallet')">💳 КОШЕЛЁК</button>
                <button class="tab" onclick="showMarketTab('auctions')">⚡ АУКЦИОНЫ</button>
                <button class="tab" onclick="showMarketTab('forum')">📋 ФОРУМ</button>
                <button class="tab" id="adminTabButton" onclick="showMarketTab('admin')" style="display: none;">🔴 АДМИН</button>
            </div>

            <!-- Items Tab -->
            <div id="itemsTab" class="tab-content">
                <div class="items-grid" id="darkItemsGrid">
                    <!-- Dark market items will be loaded here -->
                </div>
            </div>

            <!-- Gangs Tab -->
            <div id="gangsTab" class="tab-content hidden">
                <div class="gangs-section">
                    <h3 style="color: #dc2626; margin-bottom: 2rem;">👥 Доступные группировки</h3>
                    <div id="gangsGrid">
                        <!-- Gangs will be loaded here -->
                    </div>
                    
                    <div style="margin-top: 2rem; padding: 1.5rem; background: var(--dark-surface); border-radius: 10px;">
                        <h4 style="color: #dc2626; margin-bottom: 1rem;">➕ Создать группировку</h4>
                        <input type="text" id="newGangName" placeholder="Название группировки" style="width: 100%; padding: 0.5rem; margin: 0.5rem 0; background: var(--dark-bg); color: white; border: 1px solid var(--dark-border); border-radius: 5px;">
                        <button class="btn-dark" onclick="createGang()">СОЗДАТЬ</button>
                    </div>
                </div>
            </div>

            <!-- Chat Tab -->
            <div id="chatTab" class="tab-content hidden">
                <h3 style="color: #dc2626; margin-bottom: 1rem;">💬 Общий чат</h3>
                <div class="chat-container">
                    <div class="chat-messages" id="chatMessages">
                        <!-- Chat messages will appear here -->
                    </div>
                    <div class="chat-input">
                        <input type="text" id="messageInput" placeholder="Введите сообщение..." onkeypress="if(event.key==='Enter') sendMessage()">
                        <button class="btn-dark" onclick="sendMessage()">ОТПРАВИТЬ</button>
                    </div>
                </div>
            </div>

            <!-- My Items Tab -->
            <div id="myItemsTab" class="tab-content hidden">
                <h3 style="color: #dc2626; margin-bottom: 2rem;">📦 МОИ ТОВАРЫ</h3>
                <div class="items-grid" id="myItemsGrid">
                    <!-- User's items will be loaded here -->
                </div>
                <div style="margin-top: 2rem; padding: 1.5rem; background: var(--dark-surface); border-radius: 10px;">
                    <h4 style="color: #dc2626; margin-bottom: 1rem;">➕ Добавить товар</h4>
                    <input type="text" id="newItemName" placeholder="Название товара" style="width: 100%; padding: 0.5rem; margin: 0.5rem 0; background: var(--dark-bg); color: white; border: 1px solid var(--dark-border); border-radius: 5px;">
                    <select id="newItemCategory" style="width: 100%; padding: 0.5rem; margin: 0.5rem 0; background: var(--dark-bg); color: white; border: 1px solid var(--dark-border); border-radius: 5px;">
                        <option value="Оружие">Оружие</option>
                        <option value="Документы">Документы</option>
                        <option value="Фармацевтика">Фармацевтика</option>
                        <option value="Взрывчатые вещества">Взрывчатые вещества</option>
                        <option value="Другое">Другое</option>
                    </select>
                    <input type="number" id="newItemPrice" placeholder="Цена (руб)" style="width: 100%; padding: 0.5rem; margin: 0.5rem 0; background: var(--dark-bg); color: white; border: 1px solid var(--dark-border); border-radius: 5px;">
                    <textarea id="newItemDescription" placeholder="Описание товара" style="width: 100%; padding: 0.5rem; margin: 0.5rem 0; background: var(--dark-bg); color: white; border: 1px solid var(--dark-border); border-radius: 5px; min-height: 80px;"></textarea>
                    <button class="btn-dark" onclick="addNewItem()">ДОБАВИТЬ</button>
                </div>
            </div>

            <!-- Profile Tab -->
            <div id="profileTab" class="tab-content hidden">
                <div id="profileContent" style="background: var(--dark-surface); padding: 2rem; border-radius: 10px;"></div>
            </div>

            <!-- Escrow Tab -->
            <div id="escrowTab" class="tab-content hidden">
                <h3 style="color: #dc2626; margin-bottom: 2rem;">🔒 ЭСКРОУ СДЕЛКИ</h3>
                <div id="escrowList"></div>
                <div style="margin-top: 2rem; padding: 1.5rem; background: var(--dark-surface); border-radius: 10px;">
                    <h4 style="color: #dc2626; margin-bottom: 1rem;">➕ Создать безопасную сделку</h4>
                    <input type="text" id="escrowBuyer" placeholder="Логин покупателя" style="width: 100%; padding: 0.5rem; margin: 0.5rem 0; background: var(--dark-bg); color: white; border: 1px solid var(--dark-border); border-radius: 5px;">
                    <input type="number" id="escrowAmount" placeholder="Сумма сделки" style="width: 100%; padding: 0.5rem; margin: 0.5rem 0; background: var(--dark-bg); color: white; border: 1px solid var(--dark-border); border-radius: 5px;">
                    <textarea id="escrowDescription" placeholder="Описание товара/услуги" style="width: 100%; padding: 0.5rem; margin: 0.5rem 0; background: var(--dark-bg); color: white; border: 1px solid var(--dark-border); border-radius: 5px; min-height: 60px;"></textarea>
                    <button class="btn-dark" onclick="createEscrow()">СОЗДАТЬ СДЕЛКУ</button>
                </div>
            </div>

            <!-- Wallet Tab -->
            <div id="walletTab" class="tab-content hidden">
                <h3 style="color: #dc2626; margin-bottom: 2rem;">💳 КРИПТОВАЛЮТНЫЙ КОШЕЛЁК</h3>
                <div id="walletContent" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;"></div>
                <div style="margin-top: 2rem; padding: 1.5rem; background: var(--dark-surface); border-radius: 10px;">
                    <h4 style="color: #dc2626; margin-bottom: 1rem;">📊 История транзакций</h4>
                    <div id="transactionHistory" style="max-height: 300px; overflow-y: auto;"></div>
                </div>
            </div>

            <!-- Auctions Tab -->
            <div id="auctionsTab" class="tab-content hidden">
                <h3 style="color: #dc2626; margin-bottom: 2rem;">⚡ АУКЦИОНЫ</h3>
                <div id="auctionsList" class="items-grid"></div>
                <div style="margin-top: 2rem; padding: 1.5rem; background: var(--dark-surface); border-radius: 10px;">
                    <h4 style="color: #dc2626; margin-bottom: 1rem;">➕ Создать аукцион</h4>
                    <input type="text" id="auctionName" placeholder="Название лота" style="width: 100%; padding: 0.5rem; margin: 0.5rem 0; background: var(--dark-bg); color: white; border: 1px solid var(--dark-border); border-radius: 5px;">
                    <input type="number" id="auctionStart" placeholder="Начальная цена" style="width: 100%; padding: 0.5rem; margin: 0.5rem 0; background: var(--dark-bg); color: white; border: 1px solid var(--dark-border); border-radius: 5px;">
                    <input type="number" id="auctionDuration" placeholder="Длительность (минуты)" style="width: 100%; padding: 0.5rem; margin: 0.5rem 0; background: var(--dark-bg); color: white; border: 1px solid var(--dark-border); border-radius: 5px;">
                    <button class="btn-dark" onclick="createAuction()">СОЗДАТЬ АУКЦИОН</button>
                </div>
            </div>

            <!-- Forum Tab -->
            <div id="forumTab" class="tab-content hidden">
                <h3 style="color: #dc2626; margin-bottom: 2rem;">📋 ФОРУМ ПЛОЩАДКИ</h3>
                <div id="forumTopics"></div>
                <div style="margin-top: 2rem; padding: 1.5rem; background: var(--dark-surface); border-radius: 10px;">
                    <h4 style="color: #dc2626; margin-bottom: 1rem;">➕ Создать тему</h4>
                    <input type="text" id="topicTitle" placeholder="Заголовок темы" style="width: 100%; padding: 0.5rem; margin: 0.5rem 0; background: var(--dark-bg); color: white; border: 1px solid var(--dark-border); border-radius: 5px;">
                    <textarea id="topicContent" placeholder="Содержание" style="width: 100%; padding: 0.5rem; margin: 0.5rem 0; background: var(--dark-bg); color: white; border: 1px solid var(--dark-border); border-radius: 5px; min-height: 80px;"></textarea>
                    <button class="btn-dark" onclick="createTopic()">СОЗДАТЬ ТЕМУ</button>
                </div>
            </div>

            <!-- Admin Panel Tab -->
            <div id="adminTab" class="tab-content hidden">
                <div class="admin-panel">
                    <h2 style="color: var(--dark-red); text-align: center; margin-bottom: 2rem;">🔴 ПАНЕЛЬ АДМИНИСТРАТОРА</h2>
                    
                    <div class="admin-stats">
                        <div class="admin-stat-card">
                            <div class="admin-stat-value" id="totalUsers">0</div>
                            <div>Пользователей</div>
                        </div>
                        <div class="admin-stat-card">
                            <div class="admin-stat-value" id="totalItems">0</div>
                            <div>Товаров</div>
                        </div>
                        <div class="admin-stat-card">
                            <div class="admin-stat-value" id="totalGangs">0</div>
                            <div>Группировок</div>
                        </div>
                        <div class="admin-stat-card">
                            <div class="admin-stat-value" id="totalMessages">0</div>
                            <div>Сообщений</div>
                        </div>
                    </div>

                    <div class="admin-controls">
                        <div class="admin-section">
                            <h4 style="color: var(--dark-red); margin-bottom: 1rem;">👥 Управление пользователями</h4>
                            <input type="text" id="adminUserSearch" placeholder="Поиск пользователя..." style="width: 100%; padding: 0.5rem; margin-bottom: 1rem; background: var(--dark-bg); color: white; border: 1px solid var(--dark-border); border-radius: 5px;" oninput="searchUsers()">
                            <div id="usersList" style="max-height: 300px; overflow-y: auto;"></div>
                        </div>
                        
                        <div class="admin-section">
                            <h4 style="color: var(--dark-red); margin-bottom: 1rem;">📦 Управление товарами</h4>
                            <div id="adminItemsList" style="max-height: 300px; overflow-y: auto;"></div>
                        </div>
                        
                        <div class="admin-section">
                            <h4 style="color: var(--dark-red); margin-bottom: 1rem;">🏴 Управление группировками</h4>
                            <div id="adminGangsList" style="max-height: 300px; overflow-y: auto;"></div>
                        </div>
                        
                        <div class="admin-section">
                            <h4 style="color: var(--dark-red); margin-bottom: 1rem;">🔒 Эскроу споры</h4>
                            <div id="adminEscrowList" style="max-height: 300px; overflow-y: auto;"></div>
                        </div>
                        
                        <div class="admin-section">
                            <h4 style="color: var(--dark-red); margin-bottom: 1rem;">💰 Финансы</h4>
                            <div style="margin-bottom: 1rem;">
                                <div style="font-size: 1.2rem; color: var(--dark-red);">Общий баланс: <span id="totalBalance">0</span> ₽</div>
                                <div style="font-size: 0.9rem; color: var(--light-text);">Транзакций: <span id="totalTransactions">0</span></div>
                            </div>
                        </div>
                        
                        <div class="admin-section">
                            <h4 style="color: var(--dark-red); margin-bottom: 1rem;">📊 Логи входов</h4>
                            <div id="adminLogs" style="max-height: 300px; overflow-y: auto; font-size: 0.85rem;"></div>
                        </div>
                        
                        <div class="admin-section">
                            <h4 style="color: var(--dark-red); margin-bottom: 1rem;">📈 Аналитика</h4>
                            <div id="adminAnalytics"></div>
                        </div>
                        
                        <div class="admin-section">
                            <h4 style="color: var(--dark-red); margin-bottom: 1rem;">⚙️ Настройки площадки</h4>
                            <label style="display: flex; align-items: center; margin: 0.5rem 0;">
                                <input type="checkbox" id="registrationEnabled" checked style="margin-right: 0.5rem;">
                                <span>Разрешить регистрацию</span>
                            </label>
                            <label style="display: flex; align-items: center; margin: 0.5rem 0;">
                                <input type="checkbox" id="invitesRequired" checked style="margin-right: 0.5rem;">
                                <span>Требовать инвайт-ссылку</span>
                            </label>
                            <input type="text" id="accessCode" placeholder="Код доступа" value="8052" style="width: 100%; padding: 0.5rem; margin: 0.5rem 0; background: var(--dark-bg); color: white; border: 1px solid var(--dark-border); border-radius: 5px;">
                            <button class="btn-dark" onclick="saveSettings()" style="margin-top: 0.5rem;">💾 СОХРАНИТЬ</button>
                        </div>
                        
                        <div class="admin-section">
                            <h4 style="color: var(--dark-red); margin-bottom: 1rem;">🚨 Системные действия</h4>
                            <button class="btn-dark" onclick="generateInvite()">🔗 ГЕНЕРИРОВАТЬ ИНВАЙТ</button>
                            <button class="btn-dark" onclick="clearAllData()" style="margin-top: 0.5rem;">🗑️ ОЧИСТИТЬ ДАННЫЕ</button>
                            <button class="btn-dark" onclick="resetSystem()" style="margin-top: 0.5rem;">🔄 СБРОС СИСТЕМЫ</button>
                            <button class="btn-dark" onclick="exportLogs()" style="margin-top: 0.5rem;">📥 ЭКСПОРТ ЛОГОВ</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('loginModal')">&times;</span>
            <h2>🔑 Вход в систему</h2>
            <div class="form-group">
                <label>Логин:</label>
                <input type="text" id="loginUsername" placeholder="Введите логин">
            </div>
            <div class="form-group">
                <label>Пароль:</label>
                <input type="password" id="loginPassword" placeholder="Введите пароль">
            </div>
            <button class="btn btn-primary" onclick="performLogin()">Войти</button>
        </div>
    </div>

    <!-- Register Modal -->
    <div id="registerModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('registerModal')">&times;</span>
            <h2>📝 Регистрация</h2>
            <div class="form-group">
                <label>Логин:</label>
                <input type="text" id="registerUsername" placeholder="Выберите логин">
            </div>
            <div class="form-group">
                <label>Email:</label>
                <input type="email" id="registerEmail" placeholder="Введите email">
            </div>
            <div class="form-group">
                <label>Пароль:</label>
                <input type="password" id="registerPassword" placeholder="Создайте пароль">
            </div>
            <div class="form-group">
                <label>Роль:</label>
                <select id="userRole">
                    <option value="user">Читатель</option>
                    <option value="correspondent">Корреспондент</option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="performRegister()">Зарегистрироваться</button>
        </div>
    </div>

    <!-- Service Order Modal -->
    <div id="serviceModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('serviceModal')">&times;</span>
            <h2>📋 Заказ услуги</h2>
            <div id="serviceDetails"></div>
            <div class="form-group">
                <label>Ваше имя:</label>
                <input type="text" id="clientName" placeholder="Введите ваше имя">
            </div>
            <div class="form-group">
                <label>Телефон:</label>
                <input type="tel" id="clientPhone" placeholder="+7 (xxx) xxx-xx-xx">
            </div>
            <div class="form-group">
                <label>Описание ситуации:</label>
                <textarea id="caseDescription" placeholder="Опишите вашу ситуацию"></textarea>
            </div>
            <button class="btn btn-primary" onclick="submitServiceOrder()">Заказать услугу</button>
        </div>
    </div>

    <!-- Dark Web Register Modal -->
    <div id="darkRegisterModal" class="modal">
        <div class="modal-content" style="background: var(--dark-surface); color: var(--dark-text-primary); border: 2px solid var(--dark-red);">
            <span class="close" onclick="closeModal('darkRegisterModal')">&times;</span>
            <h2 style="color: var(--dark-red);">🔒 РЕГИСТРАЦИЯ НА DARKWEB</h2>
            <div class="form-group">
                <label style="color: var(--dark-red);">Логин:</label>
                <input type="text" id="darkRegUsername" placeholder="Выберите логин" style="background: var(--dark-bg); color: white; border: 1px solid var(--dark-red);">
            </div>
            <div class="form-group">
                <label style="color: var(--dark-red);">Пароль:</label>
                <input type="password" id="darkRegPassword" placeholder="Создайте пароль" style="background: var(--dark-bg); color: white; border: 1px solid var(--dark-red);">
            </div>
            <div class="form-group">
                <label style="color: var(--dark-red);">Повторите пароль:</label>
                <input type="password" id="darkRegPassword2" placeholder="Повторите пароль" style="background: var(--dark-bg); color: white; border: 1px solid var(--dark-red);">
            </div>
            <button class="btn-dark" onclick="performDarkRegister()">СОЗДАТЬ АККАУНТ</button>
            <p style="color: #666; margin-top: 1rem; font-size: 0.9rem;">⚠️ Это ролевая игра</p>
        </div>
    </div>

    <script>
        // Global state management (using in-memory storage instead of localStorage)
        let appState = {
            currentUser: null,
            ranks: [
                { name: "Новичок", emoji: "🟢", min: 0, max: 10, canCreate: false, canInvite: false, maxInvites: 0 },
                { name: "Участник", emoji: "🔵", min: 11, max: 50, canCreate: true, canInvite: false, maxInvites: 0 },
                { name: "Опытный", emoji: "🟣", min: 51, max: 100, canCreate: true, canInvite: true, maxInvites: 1 },
                { name: "Эксперт", emoji: "🟠", min: 101, max: 500, canCreate: true, canInvite: true, maxInvites: 3 },
                { name: "Мастер", emoji: "🔴", min: 501, max: 1000, canCreate: true, canInvite: true, maxInvites: 5 },
                { name: "Легенда", emoji: "⭐", min: 1001, max: 999999, canCreate: true, canInvite: true, maxInvites: 10 }
            ],
            achievements: [
                { id: 1, name: "Первая сделка", desc: "Совершите первую покупку", reward: 10, icon: "💰" },
                { id: 2, name: "Торговец", desc: "Создайте 10 объявлений", reward: 50, icon: "📦" },
                { id: 3, name: "Легенда", desc: "Достигните ранга Легенда", reward: 100, icon: "⭐" },
                { id: 4, name: "Общительный", desc: "Отправьте 100 сообщений", reward: 20, icon: "💬" },
                { id: 5, name: "Бандит", desc: "Вступите в группировку", reward: 15, icon: "🏴" }
            ],
            notifications: [],
            news: [
                {
                    id: 1,
                    title: "Экстренный выпуск: Трагедия в центре города",
                    category: "Происшествия",
                    date: "23 октября 2025",
                    time: "17:05",
                    preview: "Сегодня днём в центральном районе города произошло трагическое событие. По предварительным данным правоохранительных органов, был убит молодой человек...",
                    content: "Сегодня днём в центральном районе города произошло трагическое событие, которое потрясло местное сообщество. По предварительным данным правоохранительных органов, около 14:30 по московскому времени был убит молодой человек в возрасте приблизительно 25-30 лет. Инцидент произошёл на одной из оживлённых улиц города, недалеко от жилых кварталов и торговых точек.",
                    author: "Корреспондент News Channel 5",
                    views: 342,
                    rating: 4.5,
                    ratings: [5, 4, 5, 4, 5],
                    comments: []
                },
                {
                    id: 2,
                    title: "Городской совет обсудил новый бюджет",
                    category: "Политика",
                    date: "23 октября 2025",
                    time: "14:20",
                    preview: "На заседании городского совета были представлены основные направления бюджетной политики на следующий год...",
                    content: "На заседании городского совета были представлены основные направления бюджетной политики на следующий год. Особое внимание уделено развитию социальной сферы и инфраструктуры.",
                    author: "Политический корреспондент",
                    views: 189,
                    rating: 3.8,
                    ratings: [4, 3, 4, 4],
                    comments: []
                },
                {
                    id: 3,
                    title: "Открытие нового торгового центра",
                    category: "Экономика",
                    date: "22 октября 2025",
                    time: "18:45",
                    preview: "В западном районе города состоялось торжественное открытие крупного торгового центра...",
                    content: "В западном районе города состоялось торжественное открытие крупного торгового центра. Новый комплекс создаст более 500 рабочих мест и станет важным объектом городской инфраструктуры.",
                    author: "Экономический обозреватель",
                    views: 256,
                    rating: 4.2,
                    ratings: [4, 5, 4, 4],
                    comments: []
                }
            ],
            services: [
                {
                    id: 1,
                    name: "Консультация по уголовным делам",
                    description: "Профессиональная консультация по уголовным делам любой сложности",
                    price: "5000 ₽",
                    duration: "1 час"
                },
                {
                    id: 2,
                    name: "Защита в суде",
                    description: "Представление интересов клиента в суде",
                    price: "от 50000 ₽",
                    duration: "по договору"
                },
                {
                    id: 3,
                    name: "Составление документов",
                    description: "Подготовка исков, жалоб и других юридических документов",
                    price: "от 3000 ₽",
                    duration: "1-3 дня"
                }
            ],
            darkItems: [
                {
                    id: 1,
                    name: "🔫 Пистолет Glock 17",
                    category: "Оружие",
                    price: "150000 ₽",
                    seller: "Phantom_Dealer",
                    rating: 4.8,
                    description: "9мм, полная комплектация, 2 магазина"
                },
                {
                    id: 2,
                    name: "🏹 АК-47",
                    category: "Оружие",
                    price: "250000 ₽",
                    seller: "Shadow_Arms",
                    rating: 4.9,
                    description: "Калибр 7.62, проверенное качество"
                },
                {
                    id: 3,
                    name: "💊 Медицинские препараты",
                    category: "Фармацевтика",
                    price: "от 5000 ₽",
                    seller: "MedSupply_Pro",
                    rating: 4.6,
                    description: "Различные препараты, конфиденциальная доставка"
                },
                {
                    id: 4,
                    name: "📄 Поддельные документы",
                    category: "Документы",
                    price: "от 30000 ₽",
                    seller: "DocMaster",
                    rating: 4.7,
                    description: "Паспорта, права, дипломы"
                },
                {
                    id: 5,
                    name: "💣 Взрывчатка C4",
                    category: "Взрывчатые вещества",
                    price: "200000 ₽",
                    seller: "Bomber_Elite",
                    rating: 4.5,
                    description: "1кг, детонатор в комплекте"
                }
            ],
            gangs: [
                {
                    id: 1,
                    name: "Красные Волки",
                    members: 47,
                    territory: "Северный район",
                    reputation: 850,
                    leader: "RedWolf_Boss"
                },
                {
                    id: 2,
                    name: "Чёрные Тени",
                    members: 38,
                    territory: "Центр",
                    reputation: 720,
                    leader: "Dark_Shadow"
                }
            ],
            chatMessages: [
                { author: "ShadowMaster", text: "Кто-нибудь торгует оружием?", time: "17:23" },
                { author: "DarkTrader", text: "Есть пистолеты в наличии", time: "17:25" },
                { author: "RedWolf_Boss", text: "Красные Волки набирают новых членов", time: "17:30" }
            ],
            users: {},
            darkUsers: {},
            currentDarkUser: null,
            isDarkMode: false,
            userBalance: 50000,
            userGang: null,
            blockedUsers: {},
            failedAttempts: {},
            validInvites: [
                'https://invite.to/rp-market/sukcdik',
                'https://invite.to/rp-market/fbi', 
                'https://invite.to/rp-market/olele'
            ]
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });
        
        function initializeApp() {
            loadNews();
            loadServices();
            startDarkWebEffects();
            initializeDarkWebData();
        }
        
        function initializeDarkWebData() {
            // Initialize default admin users if they don't exist
            if (!appState.darkUsers['admin']) {
                appState.darkUsers['admin'] = {
                    username: 'admin',
                    password: btoa('admin123'),
                    role: 'darkweb_admin',
                    balance: 1000000,
                    reputation: 1000,
                    experience: 5000,
                    items: [],
                    gang: null,
                    avatar: '👑',
                    bio: 'Главный администратор площадки',
                    registered: '01.01.2024',
                    deals: 0,
                    reviews: [],
                    achievements: [],
                    invitesUsed: 0,
                    loginHistory: [],
                    actionHistory: [],
                    wallets: { btc: 10.5, eth: 50.2, usdt: 100000 }
                };
            }
            
            if (!appState.darkUsers['owner']) {
                appState.darkUsers['owner'] = {
                    username: 'owner',
                    password: btoa('owner666'),
                    role: 'darkweb_admin',
                    balance: 5000000,
                    reputation: 1000,
                    experience: 10000,
                    items: [],
                    gang: null,
                    avatar: '⭐',
                    bio: 'Владелец площадки',
                    registered: '01.01.2023',
                    deals: 0,
                    reviews: [],
                    achievements: [],
                    invitesUsed: 0,
                    loginHistory: [],
                    actionHistory: [],
                    wallets: { btc: 100.0, eth: 500.0, usdt: 5000000 }
                };
            }
            
            // Add some default sellers if they don't exist
            const defaultSellers = [
                { username: 'Phantom_Dealer', balance: 500000 },
                { username: 'Shadow_Arms', balance: 750000 },
                { username: 'MedSupply_Pro', balance: 300000 },
                { username: 'DocMaster', balance: 400000 },
                { username: 'Bomber_Elite', balance: 600000 }
            ];
            
            defaultSellers.forEach(seller => {
                if (!appState.darkUsers[seller.username]) {
                    appState.darkUsers[seller.username] = {
                        username: seller.username,
                        password: btoa('seller123'),
                        role: 'darkweb_user',
                        balance: seller.balance,
                        reputation: Math.floor(Math.random() * 500) + 200,
                        experience: Math.floor(Math.random() * 300) + 50,
                        items: [],
                        gang: null,
                        avatar: '🎭',
                        bio: 'Опытный продавец',
                        registered: '15.06.2024',
                        deals: Math.floor(Math.random() * 50) + 10,
                        reviews: [],
                        achievements: [],
                        invitesUsed: 0,
                        loginHistory: [],
                        actionHistory: [],
                        wallets: { btc: Math.random() * 5, eth: Math.random() * 20, usdt: seller.balance }
                    };
                }
            });
        }

        // Navigation functions
        function showSection(section) {
            // Hide all sections
            document.getElementById('homeSection').classList.add('hidden');
            document.getElementById('aboutSection').classList.add('hidden');
            document.getElementById('servicesSection').classList.add('hidden');
            
            // Show selected section
            document.getElementById(section + 'Section').classList.remove('hidden');
        }

        // Authentication functions
        function showLogin() {
            document.getElementById('loginModal').style.display = 'block';
        }

        function showRegister() {
            document.getElementById('registerModal').style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function performLogin() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            if (!username || !password) {
                alert('Пожалуйста, заполните все поля');
                return;
            }

            // Special dark web login
            if (username === 'dark' && password === 'web') {
                closeModal('loginModal');
                startDarkWebEntry();
                return;
            }

            // Regular login
            if (appState.users[username] && appState.users[username].password === password) {
                appState.currentUser = appState.users[username];
                updateUserInterface();
                closeModal('loginModal');
                alert('Добро пожаловать, ' + username + '!');
            } else {
                alert('Неверный логин или пароль');
            }
        }

        function performRegister() {
            const username = document.getElementById('registerUsername').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const role = document.getElementById('userRole').value;

            if (!username || !email || !password) {
                alert('Пожалуйста, заполните все поля');
                return;
            }

            if (appState.users[username]) {
                alert('Пользователь с таким логином уже существует');
                return;
            }

            appState.users[username] = {
                username: username,
                email: email,
                password: password,
                role: role
            };

            alert('Регистрация успешна! Теперь вы можете войти в систему.');
            closeModal('registerModal');
        }

        function logout() {
            appState.currentUser = null;
            updateUserInterface();
            alert('Вы вышли из системы');
        }

        function updateUserInterface() {
            if (appState.currentUser) {
                document.getElementById('authButtons').classList.add('hidden');
                document.getElementById('userInfo').classList.remove('hidden');
                document.getElementById('userName').textContent = '👤 ' + appState.currentUser.username;
                
                // Show correspondent panel if user is correspondent
                if (appState.currentUser.role === 'correspondent') {
                    document.getElementById('correspondentPanel').classList.remove('hidden');
                }
            } else {
                document.getElementById('authButtons').classList.remove('hidden');
                document.getElementById('userInfo').classList.add('hidden');
                document.getElementById('correspondentPanel').classList.add('hidden');
            }
        }

        // News functions
        function filterNews() {
            const search = document.getElementById('newsSearch').value.toLowerCase();
            const category = document.getElementById('categoryFilter').value;
            const sort = document.getElementById('sortOrder').value;
            
            let filtered = appState.news.filter(n => {
                const matchSearch = n.title.toLowerCase().includes(search) || n.preview.toLowerCase().includes(search);
                const matchCategory = category === 'all' || n.category === category;
                return matchSearch && matchCategory;
            });
            
            // Sort
            if (sort === 'popular') {
                filtered.sort((a, b) => (b.rating || 0) - (a.rating || 0));
            } else if (sort === 'views') {
                filtered.sort((a, b) => (b.views || 0) - (a.views || 0));
            }
            
            displayNews(filtered);
        }
        
        function loadNews() {
            displayNews(appState.news);
        }
        
        function displayNews(newsArray) {
            const newsGrid = document.getElementById('newsGrid');
            newsGrid.innerHTML = '';

            newsArray.forEach(news => {
                const newsCard = document.createElement('div');
                newsCard.className = 'news-card';
                
                // Check if current user is the author and can delete
                const canDelete = appState.currentUser && 
                                 (appState.currentUser.username === news.author || appState.currentUser.role === 'admin');
                
                const deleteButton = canDelete ? 
                    `<button class="delete-btn" onclick="deleteNews(${news.id})" style="margin-top: 1rem;">🗑️ Удалить</button>` : '';
                
                newsCard.innerHTML = `
                    <div class="news-content">
                        <div class="news-meta">
                            <span class="news-category">${news.category}</span>
                            <span>${news.date} ${news.time}</span>
                        </div>
                        <h3 onclick="openNewsDetail(${news.id})" style="cursor: pointer; color: var(--primary-color);">${news.title}</h3>
                        <p class="news-preview">${news.preview}</p>
                        <div style="display: flex; justify-content: space-between; margin: 1rem 0; font-size: 0.9rem; color: var(--light-text);">
                            <span>✍️ ${news.author}</span>
                            <span>👁️ ${news.views || 0} просмотров</span>
                        </div>
                        <div style="display: flex; gap: 0.5rem; margin: 1rem 0;">
                            <button class="btn btn-primary" onclick="openNewsDetail(${news.id})" style="padding: 0.5rem 1rem;">📝 Читать</button>
                            <button class="btn btn-secondary" onclick="rateNews(${news.id})" style="padding: 0.5rem 1rem;">⭐ Оценить</button>
                            <button class="btn btn-secondary" onclick="shareNews(${news.id})" style="padding: 0.5rem 1rem;">🔗 Поделиться</button>
                        </div>
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <span style="color: #f59e0b;">★ ${(news.rating || 0).toFixed(1)}</span>
                            <span style="color: var(--light-text);">💬 ${(news.comments || []).length} комментариев</span>
                        </div>
                        ${deleteButton}
                    </div>
                `;
                newsGrid.appendChild(newsCard);
            });
        }
        
        function deleteNews(newsId) {
            if (confirm('Вы уверены, что хотите удалить эту новость?')) {
                appState.news = appState.news.filter(news => news.id !== newsId);
                loadNews();
                alert('Новость удалена!');
            }
        }
        
        function openNewsDetail(newsId) {
            const news = appState.news.find(n => n.id === newsId);
            if (!news) return;
            
            // Increment views
            if (!news.views) news.views = 0;
            news.views++;
            
            if (!news.comments) news.comments = [];
            
            let commentSection = news.comments.map((c, i) => 
                `\n\n[👤 ${c.author}] (${c.time}):\n${c.text}\n♥ ${c.likes || 0}`
            ).join('');
            
            let fullText = `${news.title}\n\nАвтор: ${news.author}\n📅 ${news.date} ${news.time}\n⭐ Рейтинг: ${(news.rating || 0).toFixed(1)}\n👁️ Просмотров: ${news.views}\n\n${news.content}${commentSection ? '\n\n--- КОММЕНТАРИИ ---' + commentSection : ''}`;
            
            alert(fullText);
            
            // Offer to comment
            if (appState.currentUser) {
                const comment = prompt('Оставить комментарий:');
                if (comment && comment.trim()) {
                    news.comments.push({
                        author: appState.currentUser.username,
                        text: comment,
                        time: new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }),
                        likes: 0
                    });
                    alert('✅ Комментарий добавлен!');
                    loadNews();
                }
            }
        }
        
        function rateNews(newsId) {
            const news = appState.news.find(n => n.id === newsId);
            if (!news) return;
            
            const rating = prompt('Оцените статью (1-5):', '5');
            const rate = parseInt(rating);
            
            if (rate >= 1 && rate <= 5) {
                if (!news.ratings) news.ratings = [];
                news.ratings.push(rate);
                news.rating = news.ratings.reduce((a, b) => a + b, 0) / news.ratings.length;
                alert(`✅ Спасибо за оценку!\nСредний рейтинг: ${news.rating.toFixed(1)} ⭐`);
                loadNews();
            }
        }
        
        function shareNews(newsId) {
            const news = appState.news.find(n => n.id === newsId);
            if (!news) return;
            
            const shareUrl = `https://truenews.ru/news/${newsId}`;
            const shareText = `${news.title}\n\n${shareUrl}`;
            
            const platform = prompt('Поделиться в:\n1. VK\n2. Telegram\n3. Скопировать ссылку', '3');
            
            if (platform === '1') {
                alert('🔗 Поделиться в VK:\nvk.com/share.php?url=' + encodeURIComponent(shareUrl));
            } else if (platform === '2') {
                alert('🔗 Поделиться в Telegram:\nt.me/share/url?url=' + encodeURIComponent(shareUrl));
            } else {
                alert('✅ Ссылка скопирована!\n\n' + shareUrl);
            }
        }

        function publishNews() {
            if (!appState.currentUser || appState.currentUser.role !== 'correspondent') {
                alert('Только корреспонденты могут публиковать новости');
                return;
            }

            const title = document.getElementById('newsTitle').value;
            const category = document.getElementById('newsCategory').value;
            const preview = document.getElementById('newsPreview').value;
            const content = document.getElementById('newsContent').value;

            if (!title || !preview || !content) {
                alert('Пожалуйста, заполните все поля');
                return;
            }

            const now = new Date();
            const newNews = {
                id: appState.news.length + 1,
                title: title,
                category: category,
                date: now.toLocaleDateString('ru-RU'),
                time: now.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }),
                preview: preview,
                content: content,
                author: appState.currentUser.username
            };

            appState.news.unshift(newNews);
            loadNews();
            
            // Clear form
            document.getElementById('newsTitle').value = '';
            document.getElementById('newsPreview').value = '';
            document.getElementById('newsContent').value = '';
            
            alert('Новость успешно опубликована!');
        }

        // Services functions
        function loadServices() {
            const servicesGrid = document.getElementById('servicesGrid');
            servicesGrid.innerHTML = '';

            appState.services.forEach(service => {
                const serviceCard = document.createElement('div');
                serviceCard.className = 'service-card';
                serviceCard.innerHTML = `
                    <h3>${service.name}</h3>
                    <p>${service.description}</p>
                    <div class="service-price">${service.price}</div>
                    <p style="color: var(--light-text);">⏱️ ${service.duration}</p>
                    <button class="btn btn-primary" onclick="orderService(${service.id})">Заказать</button>
                `;
                servicesGrid.appendChild(serviceCard);
            });
        }

        function orderService(serviceId) {
            const service = appState.services.find(s => s.id === serviceId);
            document.getElementById('serviceDetails').innerHTML = `
                <h3>${service.name}</h3>
                <p>${service.description}</p>
                <p><strong>Стоимость:</strong> ${service.price}</p>
                <p><strong>Срок:</strong> ${service.duration}</p>
                <hr style="margin: 1rem 0;">
            `;
            document.getElementById('serviceModal').style.display = 'block';
        }

        function submitServiceOrder() {
            const name = document.getElementById('clientName').value;
            const phone = document.getElementById('clientPhone').value;
            const description = document.getElementById('caseDescription').value;

            if (!name || !phone || !description) {
                alert('Пожалуйста, заполните все поля');
                return;
            }

            alert('Заявка отправлена! Адвокат свяжется с вами в течение 24 часов.');
            closeModal('serviceModal');
        }

        // Dark Web functions with multi-step verification
        function startDarkWebEntry() {
            document.getElementById('mainSite').classList.add('hidden');
            document.getElementById('darkLoading').classList.remove('hidden');
            
            startMatrixEffect();
            simulateLoading();
        }
        
        function startMatrixEffect() {
            const matrixBg = document.getElementById('matrixBg');
            matrixBg.innerHTML = '';
            
            const chars = 'АБВГДЕЖЗИКЛМНОПРСТУФХЦЧШЭЮЯ0123456789!@#$%^&*()';
            
            for (let i = 0; i < 20; i++) {
                const column = document.createElement('div');
                column.className = 'matrix-column';
                column.style.left = Math.random() * 100 + '%';
                column.style.animationDuration = (Math.random() * 3 + 2) + 's';
                column.style.animationDelay = Math.random() * 2 + 's';
                
                let text = '';
                for (let j = 0; j < 20; j++) {
                    text += chars.charAt(Math.floor(Math.random() * chars.length)) + '<br>';
                }
                column.innerHTML = text;
                
                matrixBg.appendChild(column);
            }
        }
        
        function simulateLoading() {
            const progressFill = document.getElementById('progressFill');
            const loadingText = document.getElementById('loadingText');
            
            const messages = [
                'CONNECTING TO DARK NET...',
                'ESTABLISHING ENCRYPTED CONNECTION...',
                'BYPASSING SECURITY PROTOCOLS...',
                'ACCESSING HIDDEN SERVICES...',
                'CONNECTION ESTABLISHED'
            ];
            
            let progress = 0;
            let messageIndex = 0;
            
            const interval = setInterval(() => {
                progress += Math.random() * 15 + 5;
                progressFill.style.width = Math.min(progress, 100) + '%';
                
                if (messageIndex < messages.length - 1 && progress > (messageIndex + 1) * 20) {
                    messageIndex++;
                    loadingText.textContent = messages[messageIndex];
                }
                
                if (progress >= 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        document.getElementById('darkLoading').classList.add('hidden');
                        document.getElementById('darkVerification1').classList.remove('hidden');
                    }, 1000);
                }
            }, 200);
        }
        
        function verifyStep1() {
            const code = document.getElementById('verificationCode').value;
            if (code === '678') {
                document.getElementById('darkVerification1').classList.add('hidden');
                document.getElementById('darkVerification2').classList.remove('hidden');
                addGlitchEffect();
            } else {
                alert('❌ НЕВЕРНЫЙ КОД ДОСТУПА');
                document.getElementById('verificationCode').value = '';
            }
        }
        
        function verifyStep2() {
            const link = document.getElementById('inviteLink').value;
            if (appState.validInvites.includes(link)) {
                document.getElementById('darkVerification2').classList.add('hidden');
                document.getElementById('darkVerification3').classList.remove('hidden');
                addGlitchEffect();
            } else {
                alert('❌ НЕДЕЙСТВИТЕЛЬНАЯ ССЫЛКА');
                document.getElementById('inviteLink').value = '';
            }
        }
        
        function verifyStep3() {
            const username = document.getElementById('darkUsername').value;
            const password = document.getElementById('darkPassword').value;
            
            if (!username || !password) {
                alert('Заполните все поля');
                return;
            }
            
            // Check for blocked users
            if (appState.blockedUsers[username]) {
                const blockTime = appState.blockedUsers[username];
                const now = Date.now();
                if (now < blockTime) {
                    const remainingTime = Math.ceil((blockTime - now) / 1000);
                    alert(`❌ ПОЛЬЗОВАТЕЛЬ ЗАБЛОКИРОВАН. Осталось: ${remainingTime} сек.`);
                    return;
                } else {
                    delete appState.blockedUsers[username];
                }
            }
            
            // Check credentials
            if (appState.darkUsers[username] && appState.darkUsers[username].password === btoa(password)) {
                appState.currentDarkUser = appState.darkUsers[username];
                delete appState.failedAttempts[username];
                
                // Log login
                if (!appState.currentDarkUser.loginHistory) appState.currentDarkUser.loginHistory = [];
                appState.currentDarkUser.loginHistory.push({
                    time: new Date().toLocaleString('ru-RU'),
                    ip: '127.0.0.' + Math.floor(Math.random() * 255),
                    device: 'Browser'
                });
                
                // Daily login bonus
                addExperience(1, 'Ежедневный вход');
                
                enterDarkMarket();
                showWelcomeMessage();
            } else {
                // Handle failed login
                if (!appState.failedAttempts[username]) {
                    appState.failedAttempts[username] = 0;
                }
                appState.failedAttempts[username]++;
                
                if (appState.failedAttempts[username] >= 3) {
                    appState.blockedUsers[username] = Date.now() + 300000; // 5 minutes
                    alert('❌ СЛИШКОМ МНОГО НЕУДАЧНЫХ ПОПЫТОК. ПОЛЬЗОВАТЕЛЬ ЗАБЛОКИРОВАН НА 5 МИНУТ.');
                } else {
                    alert(`❌ НЕВЕРНЫЕ ДАННЫЕ. Осталось попыток: ${3 - appState.failedAttempts[username]}`);
                }
                document.getElementById('darkPassword').value = '';
            }
        }
        
        function showDarkRegister() {
            document.getElementById('darkRegisterModal').style.display = 'block';
        }
        
        function performDarkRegister() {
            const username = document.getElementById('darkRegUsername').value;
            const password = document.getElementById('darkRegPassword').value;
            const password2 = document.getElementById('darkRegPassword2').value;
            
            if (!username || !password || !password2) {
                alert('Заполните все поля');
                return;
            }
            
            if (password !== password2) {
                alert('Пароли не совпадают');
                return;
            }
            
            if (appState.darkUsers[username]) {
                alert('Пользователь с таким логином уже существует');
                return;
            }
            
            appState.darkUsers[username] = {
                username: username,
                password: btoa(password),
                role: 'darkweb_user',
                balance: 25000,
                reputation: 0,
                experience: 0,
                items: [],
                gang: null,
                avatar: '🎭',
                bio: '',
                registered: new Date().toLocaleDateString('ru-RU'),
                deals: 0,
                reviews: [],
                achievements: [],
                invitesUsed: 0,
                loginHistory: [],
                actionHistory: [],
                wallets: { btc: 0, eth: 0, usdt: 25000 }
            };
            
            closeModal('darkRegisterModal');
            alert('Аккаунт создан! Теперь вы можете войти.');
        }
        
        function enterDarkMarket() {
            document.getElementById('darkVerification3').classList.add('hidden');
            document.getElementById('darkMarket').classList.remove('hidden');
            appState.isDarkMode = true;
            loadDarkMarket();
            updateDarkUserInterface();
            addGlitchEffect();
        }
        
        function updateDarkUserInterface() {
            if (appState.currentDarkUser) {
                document.getElementById('userBalance').textContent = appState.currentDarkUser.balance;
                
                // Show admin panel if user is admin or owner
                if (appState.currentDarkUser.username === 'admin' || appState.currentDarkUser.username === 'owner') {
                    document.getElementById('adminTabButton').style.display = 'block';
                    appState.currentDarkUser.role = 'darkweb_admin';
                }
            }
        }

        function exitDarkMarket() {
            appState.isDarkMode = false;
            appState.currentDarkUser = null;
            document.getElementById('darkMarket').classList.add('hidden');
            document.getElementById('mainSite').classList.remove('hidden');
            document.getElementById('adminTabButton').style.display = 'none';
        }

        function loadDarkMarket() {
            loadDarkItems();
            loadGangs();
            loadChat();
        }

        function filterMarketItems() {
            const search = document.getElementById('marketSearch').value.toLowerCase();
            const category = document.getElementById('marketCategory').value;
            const priceMin = parseInt(document.getElementById('priceMin').value) || 0;
            const priceMax = parseInt(document.getElementById('priceMax').value) || Infinity;
            const sort = document.getElementById('marketSort').value;
            
            let filtered = appState.darkItems.filter(item => {
                const price = parseInt(item.price.replace(/[^0-9]/g, ''));
                const matchSearch = item.name.toLowerCase().includes(search) || item.description.toLowerCase().includes(search);
                const matchCategory = category === 'all' || item.category === category;
                const matchPrice = price >= priceMin && price <= priceMax;
                return matchSearch && matchCategory && matchPrice;
            });
            
            // Sort
            if (sort === 'cheap') {
                filtered.sort((a, b) => parseInt(a.price.replace(/[^0-9]/g, '')) - parseInt(b.price.replace(/[^0-9]/g, '')));
            } else if (sort === 'expensive') {
                filtered.sort((a, b) => parseInt(b.price.replace(/[^0-9]/g, '')) - parseInt(a.price.replace(/[^0-9]/g, '')));
            } else if (sort === 'popular') {
                filtered.sort((a, b) => (b.rating || 0) - (a.rating || 0));
            }
            
            displayDarkItems(filtered);
        }
        
        function loadDarkItems() {
            displayDarkItems(appState.darkItems);
        }
        
        function displayDarkItems(itemsArray) {
            const itemsGrid = document.getElementById('darkItemsGrid');
            itemsGrid.innerHTML = '';

            itemsArray.forEach(item => {
                const itemCard = document.createElement('div');
                itemCard.className = 'item-card';
                itemCard.innerHTML = `
                    <div class="item-name">${item.name}</div>
                    <div class="item-price">${item.price}</div>
                    <div class="seller-info">
                        <span>👤 ${item.seller}</span>
                        <span class="rating">⭐ ${item.rating}</span>
                    </div>
                    <p style="margin: 1rem 0; font-size: 0.9rem;">${item.description}</p>
                    <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                        <button class="btn-dark" onclick="buyItem(${item.id})">💰 КУПИТЬ</button>
                        <button class="btn-dark" onclick="viewSellerProfile('${item.seller}')" style="background: var(--dark-surface);">👤 ПРОФИЛЬ</button>
                    </div>
                `;
                itemsGrid.appendChild(itemCard);
            });
        }

        function buyItem(itemId) {
            if (!appState.currentDarkUser) {
                alert('Войдите в аккаунт');
                return;
            }
            
            const item = appState.darkItems.find(i => i.id === itemId);
            const price = parseInt(item.price.replace(/[^0-9]/g, ''));
            
            if (appState.currentDarkUser.balance >= price) {
                appState.currentDarkUser.balance -= price;
                document.getElementById('userBalance').textContent = appState.currentDarkUser.balance;
                
                // Add to seller's balance (if seller exists)
                if (appState.darkUsers[item.seller]) {
                    appState.darkUsers[item.seller].balance += Math.floor(price * 0.9); // 90% to seller
                    appState.darkUsers[item.seller].deals = (appState.darkUsers[item.seller].deals || 0) + 1;
                }
                
                // Add experience for deal
                appState.currentDarkUser.deals++;
                addExperience(10, 'Успешная сделка');
                checkAchievements();
                
                alert(`✅ Покупка совершена: ${item.name}\nПродавец: ${item.seller}\n\n+10 опыта за сделку!\n\n⚠️ ВНИМАНИЕ: Это ролевая игра!`);
                addGlitchEffect();
                
                // Open chat with seller
                openSellerChat(item.seller);
            } else {
                alert('❌ Недостаточно средств');
            }
        }
        
        function openSellerChat(sellerName) {
            const chatMessage = `Привет, ${sellerName}! Я купил у вас товар. Когда можно ожидать доставку?`;
            
            // Auto-add message to chat
            appState.chatMessages.push({
                author: appState.currentDarkUser.username,
                text: chatMessage,
                time: new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' })
            });
            
            // Show chat tab
            showMarketTab('chat');
            loadChat();
        }

        function loadGangs() {
            const gangsGrid = document.getElementById('gangsGrid');
            gangsGrid.innerHTML = '';

            appState.gangs.forEach(gang => {
                const gangCard = document.createElement('div');
                gangCard.className = 'gang-card';
                gangCard.innerHTML = `
                    <div class="gang-name">${gang.name}</div>
                    <div class="gang-stats">
                        <div class="stat">
                            <div class="stat-value">${gang.members}</div>
                            <div class="stat-label">Участников</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value">${gang.reputation}</div>
                            <div class="stat-label">Репутация</div>
                        </div>
                    </div>
                    <p>🏴 Территория: ${gang.territory}</p>
                    <p>👑 Лидер: ${gang.leader}</p>
                    <button class="btn-dark" onclick="joinGang(${gang.id})">ВСТУПИТЬ</button>
                `;
                gangsGrid.appendChild(gangCard);
            });
        }

        function joinGang(gangId) {
            const gang = appState.gangs.find(g => g.id === gangId);
            appState.userGang = gang;
            gang.members += 1;
            alert(`🏴 Вы вступили в группировку "${gang.name}"`);            loadGangs();
            addFreezeEffect();
        }

        function createGang() {
            if (!appState.currentDarkUser) {
                alert('Войдите в аккаунт');
                return;
            }
            
            if (appState.currentDarkUser.gang) {
                alert('Вы уже состоите в группировке');
                return;
            }
            
            const name = document.getElementById('newGangName').value;
            if (!name) {
                alert('Введите название группировки');
                return;
            }

            const newGang = {
                id: appState.gangs.length + 1,
                name: name,
                members: 1,
                territory: 'Не определена',
                reputation: 100,
                leader: appState.currentDarkUser.username,
                treasury: 0,
                inventory: []
            };

            appState.gangs.push(newGang);
            appState.currentDarkUser.gang = name;
            
            // Add experience
            addExperience(5, 'Создание группировки');
            
            loadGangs();
            document.getElementById('newGangName').value = '';
            alert(`🏴 Группировка "${name}" создана!\n\n+5 опыта!`);
        }

        function loadChat() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';

            appState.chatMessages.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message';
                messageDiv.innerHTML = `
                    <div class="message-author">${msg.author}</div>
                    <div class="message-text">${msg.text}</div>
                `;
                chatMessages.appendChild(messageDiv);
            });

            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message) return;
            
            if (!appState.currentDarkUser) {
                alert('Войдите в аккаунт');
                return;
            }

            const newMessage = {
                author: appState.currentDarkUser.username,
                text: message,
                time: new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' })
            };

            appState.chatMessages.push(newMessage);
            messageInput.value = '';
            loadChat();
        }

        function showMarketTab(tab) {
            // Hide all tabs
            document.getElementById('itemsTab').classList.add('hidden');
            document.getElementById('gangsTab').classList.add('hidden');
            document.getElementById('chatTab').classList.add('hidden');
            document.getElementById('myItemsTab').classList.add('hidden');
            document.getElementById('profileTab').classList.add('hidden');
            document.getElementById('escrowTab').classList.add('hidden');
            document.getElementById('walletTab').classList.add('hidden');
            document.getElementById('auctionsTab').classList.add('hidden');
            document.getElementById('forumTab').classList.add('hidden');
            document.getElementById('adminTab').classList.add('hidden');
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(tab + 'Tab').classList.remove('hidden');
            if (event && event.target) {
                event.target.classList.add('active');
            }
            
            // Load specific tab data
            if (tab === 'myItems') {
                loadMyItems();
            } else if (tab === 'profile') {
                loadProfile();
            } else if (tab === 'escrow') {
                loadEscrow();
            } else if (tab === 'wallet') {
                loadWallet();
            } else if (tab === 'auctions') {
                loadAuctions();
            } else if (tab === 'forum') {
                loadForum();
            } else if (tab === 'admin') {
                loadAdminPanel();
            }
        }
        
        // My Items functions
        function loadMyItems() {
            if (!appState.currentDarkUser) return;
            
            const myItemsGrid = document.getElementById('myItemsGrid');
            myItemsGrid.innerHTML = '';
            
            const userItems = appState.darkItems.filter(item => item.seller === appState.currentDarkUser.username);
            
            if (userItems.length === 0) {
                myItemsGrid.innerHTML = '<p style="color: var(--dark-text-secondary); text-align: center;">У вас нет товаров</p>';
                return;
            }
            
            userItems.forEach(item => {
                const itemCard = document.createElement('div');
                itemCard.className = 'item-card';
                itemCard.innerHTML = `
                    <div class="item-name">${item.name}</div>
                    <div class="item-price">${item.price}</div>
                    <p style="margin: 1rem 0; font-size: 0.9rem;">${item.description}</p>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn-dark" onclick="editItem(${item.id})">✏️ РЕДАКТИРОВАТЬ</button>
                        <button class="delete-btn" onclick="deleteItem(${item.id})">🗑️ УДАЛИТЬ</button>
                    </div>
                `;
                myItemsGrid.appendChild(itemCard);
            });
        }
        
        function addNewItem() {
            if (!appState.currentDarkUser) {
                alert('Войдите в аккаунт');
                return;
            }
            
            // Check rank restrictions
            const rank = getUserRank(appState.currentDarkUser.experience);
            if (!rank.canCreate) {
                alert(`❌ ДОСТУП ЗАПРЕЩЁН!\n\nВаш ранг: ${rank.emoji} ${rank.name}\nДля создания объявлений нужен ранг "Участник" или выше (11+ опыта)\n\nВаш опыт: ${appState.currentDarkUser.experience}`);
                return;
            }
            
            const name = document.getElementById('newItemName').value;
            const category = document.getElementById('newItemCategory').value;
            const price = document.getElementById('newItemPrice').value;
            const description = document.getElementById('newItemDescription').value;
            
            if (!name || !price || !description) {
                alert('Заполните все поля');
                return;
            }
            
            const newItem = {
                id: appState.darkItems.length + 1,
                name: name,
                category: category,
                price: price + ' ₽',
                seller: appState.currentDarkUser.username,
                rating: 0,
                description: description
            };
            
            appState.darkItems.push(newItem);
            
            // Add experience
            addExperience(5, 'Создание объявления');
            
            // Clear form
            document.getElementById('newItemName').value = '';
            document.getElementById('newItemPrice').value = '';
            document.getElementById('newItemDescription').value = '';
            
            alert('✅ Товар добавлен! +5 опыта');
            loadMyItems();
            loadDarkItems();
        }
        
        // Rank and Experience System
        function getUserRank(exp) {
            for (let rank of appState.ranks) {
                if (exp >= rank.min && exp <= rank.max) {
                    return rank;
                }
            }
            return appState.ranks[0];
        }
        
        function addExperience(amount, reason) {
            if (!appState.currentDarkUser) return;
            
            const oldExp = appState.currentDarkUser.experience;
            const oldRank = getUserRank(oldExp);
            
            appState.currentDarkUser.experience += amount;
            const newRank = getUserRank(appState.currentDarkUser.experience);
            
            // Log action
            appState.currentDarkUser.actionHistory.push({
                action: reason,
                exp: amount,
                time: new Date().toLocaleTimeString('ru-RU')
            });
            
            // Check for rank up
            if (oldRank.name !== newRank.name) {
                alert(`🎉 ПОВЫШЕНИЕ РАНГА!\n\n${oldRank.emoji} ${oldRank.name} → ${newRank.emoji} ${newRank.name}\n\nНовые возможности разблокированы!`);
                checkAchievements();
            }
            
            addNotification(`+${amount} опыта: ${reason}`);
        }
        
        function checkAchievements() {
            if (!appState.currentDarkUser) return;
            
            appState.achievements.forEach(ach => {
                if (!appState.currentDarkUser.achievements.includes(ach.id)) {
                    let earned = false;
                    
                    if (ach.id === 1 && appState.currentDarkUser.deals >= 1) earned = true;
                    if (ach.id === 2 && appState.currentDarkUser.items && appState.currentDarkUser.items.length >= 10) earned = true;
                    if (ach.id === 3 && appState.currentDarkUser.experience >= 1001) earned = true;
                    if (ach.id === 5 && appState.currentDarkUser.gang) earned = true;
                    
                    if (earned) {
                        appState.currentDarkUser.achievements.push(ach.id);
                        appState.currentDarkUser.experience += ach.reward;
                        alert(`🏆 ДОСТИЖЕНИЕ РАЗБЛОКИРОВАНО!\n\n${ach.icon} ${ach.name}\n${ach.desc}\n\n+${ach.reward} опыта!`);
                    }
                }
            });
        }
        
        function addNotification(text) {
            appState.notifications.unshift({
                text: text,
                time: new Date().toLocaleTimeString('ru-RU'),
                read: false
            });
            if (appState.notifications.length > 50) {
                appState.notifications = appState.notifications.slice(0, 50);
            }
        }
        
        // Profile Functions
        function loadProfile() {
            if (!appState.currentDarkUser) return;
            
            const user = appState.currentDarkUser;
            const rank = getUserRank(user.experience);
            const nextRank = appState.ranks.find(r => r.min > user.experience) || rank;
            const progress = ((user.experience - rank.min) / (rank.max - rank.min)) * 100;
            
            const profileContent = document.getElementById('profileContent');
            profileContent.innerHTML = `
                <div style="text-align: center; margin-bottom: 2rem;">
                    <div style="font-size: 4rem;">${user.avatar}</div>
                    <h2 style="color: var(--dark-red); margin: 1rem 0;">${user.username}</h2>
                    <div style="font-size: 1.5rem; margin: 0.5rem 0;">${rank.emoji} ${rank.name}</div>
                    <div style="font-size: 0.9rem; color: var(--light-text); margin-top: 0.5rem;">
                        🔔 Уведомлений: ${appState.notifications.filter(n => !n.read).length}
                    </div>
                </div>
                
                <div style="background: var(--dark-bg); padding: 1.5rem; border-radius: 10px; margin: 1rem 0;">
                    <h4 style="color: var(--dark-red); margin-bottom: 1rem;">📊 Опыт и прогресс</h4>
                    <div style="margin-bottom: 0.5rem;">Опыт: ${user.experience} / ${nextRank.min}</div>
                    <div style="background: var(--dark-surface); height: 20px; border-radius: 10px; overflow: hidden; margin: 0.5rem 0;">
                        <div style="background: var(--dark-red); height: 100%; width: ${progress}%; transition: width 0.3s;"></div>
                    </div>
                    <div style="font-size: 0.9rem; color: var(--light-text);">До следующего ранга: ${nextRank.min - user.experience} опыта</div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin: 1rem 0;">
                    <div style="background: var(--dark-bg); padding: 1rem; border-radius: 8px; text-align: center;">
                        <div style="font-size: 2rem; color: var(--dark-red);">${user.balance}</div>
                        <div style="font-size: 0.9rem;">Баланс (₽)</div>
                    </div>
                    <div style="background: var(--dark-bg); padding: 1rem; border-radius: 8px; text-align: center;">
                        <div style="font-size: 2rem; color: var(--dark-red);">${user.deals}</div>
                        <div style="font-size: 0.9rem;">Сделок</div>
                    </div>
                    <div style="background: var(--dark-bg); padding: 1rem; border-radius: 8px; text-align: center;">
                        <div style="font-size: 2rem; color: var(--dark-red);">${user.reputation}</div>
                        <div style="font-size: 0.9rem;">Репутация</div>
                    </div>
                </div>
                
                <div style="background: var(--dark-bg); padding: 1.5rem; border-radius: 10px; margin: 1rem 0;">
                    <h4 style="color: var(--dark-red); margin-bottom: 1rem;">ℹ️ Информация</h4>
                    <div style="margin: 0.5rem 0;">📅 Регистрация: ${user.registered}</div>
                    <div style="margin: 0.5rem 0;">🏴 Группировка: ${user.gang || 'Нет'}</div>
                    <div style="margin: 0.5rem 0;">📝 Биография: ${user.bio || 'Не указана'}</div>
                </div>
                
                <div style="background: var(--dark-bg); padding: 1.5rem; border-radius: 10px; margin: 1rem 0;">
                    <h4 style="color: var(--dark-red); margin-bottom: 1rem;">🎯 Возможности ранга</h4>
                    <div style="margin: 0.5rem 0;">✅ Создание объявлений: ${rank.canCreate ? 'Да' : '❌ Нет (нужен ранг Участник)'}</div>
                    <div style="margin: 0.5rem 0;">✅ Приглашения: ${rank.canInvite ? `Да (${rank.maxInvites} шт.)` : '❌ Нет (нужен ранг Опытный)'}</div>
                    <div style="margin: 0.5rem 0;">✅ Использовано инвайтов: ${user.invitesUsed} / ${rank.maxInvites}</div>
                </div>
                
                <div style="background: var(--dark-bg); padding: 1.5rem; border-radius: 10px; margin: 1rem 0;">
                    <h4 style="color: var(--dark-red); margin-bottom: 1rem;">🏆 Достижения (${user.achievements.length}/${appState.achievements.length})</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem;">
                        ${appState.achievements.map(ach => {
                            const earned = user.achievements.includes(ach.id);
                            return `<div style="background: var(--dark-surface); padding: 1rem; border-radius: 8px; text-align: center; opacity: ${earned ? 1 : 0.3};">
                                <div style="font-size: 2rem;">${ach.icon}</div>
                                <div style="font-size: 0.9rem; margin-top: 0.5rem;">${ach.name}</div>
                                ${earned ? '<div style="color: #10b981; font-size: 0.8rem;">✓ Получено</div>' : ''}
                            </div>`;
                        }).join('')}
                    </div>
                </div>
                
                <div style="background: var(--dark-bg); padding: 1.5rem; border-radius: 10px; margin: 1rem 0;">
                    <h4 style="color: var(--dark-red); margin-bottom: 1rem;">📋 История действий</h4>
                    <div style="max-height: 200px; overflow-y: auto;">
                        ${user.actionHistory.slice(-10).reverse().map(h => 
                            `<div style="margin: 0.5rem 0; padding: 0.5rem; background: var(--dark-surface); border-radius: 5px;">
                                <span style="color: var(--dark-red);">${h.time}</span> - ${h.action} (+${h.exp} опыта)
                            </div>`
                        ).join('') || '<div style="color: var(--light-text);">История пуста</div>'}
                    </div>
                </div>
                
                <div style="background: var(--dark-bg); padding: 1.5rem; border-radius: 10px; margin: 1rem 0;">
                    <h4 style="color: var(--dark-red); margin-bottom: 1rem;">🔔 Уведомления</h4>
                    <div style="max-height: 200px; overflow-y: auto;">
                        ${appState.notifications.slice(0, 10).map(n => 
                            `<div style="margin: 0.5rem 0; padding: 0.5rem; background: var(--dark-surface); border-radius: 5px; ${n.read ? 'opacity: 0.6;' : ''}">
                                <span style="color: var(--dark-red);">${n.time}</span> - ${n.text}
                            </div>`
                        ).join('') || '<div style="color: var(--light-text);">Нет уведомлений</div>'}
                    </div>
                    ${appState.notifications.length > 0 ? '<button class="btn-dark" onclick="markAllRead()" style="margin-top: 0.5rem;">✓ ПРОЧИТАТЬ ВСЕ</button>' : ''}
                </div>
                
                <div style="background: var(--dark-bg); padding: 1.5rem; border-radius: 10px; margin: 1rem 0;">
                    <h4 style="color: var(--dark-red); margin-bottom: 1rem;">🔐 Безопасность</h4>
                    <div>Последний вход: ${user.loginHistory && user.loginHistory.length > 0 ? user.loginHistory[user.loginHistory.length - 1].time : 'Неизвестно'}</div>
                    <div style="margin-top: 0.5rem;">IP: ${user.loginHistory && user.loginHistory.length > 0 ? user.loginHistory[user.loginHistory.length - 1].ip : 'N/A'}</div>
                    <div style="margin-top: 1rem;">
                        <button class="btn-dark" onclick="viewLoginHistory()">📊 ИСТОРИЯ ВХОДОВ</button>
                    </div>
                </div>
                
                <div style="margin-top: 2rem;">
                    <button class="btn-dark" onclick="editProfile()">✏️ РЕДАКТИРОВАТЬ ПРОФИЛЬ</button>
                    ${rank.canInvite && user.invitesUsed < rank.maxInvites ? 
                        '<button class="btn-dark" onclick="generateUserInvite()" style="margin-left: 1rem;">🔗 СОЗДАТЬ ИНВАЙТ</button>' : ''}
                    <button class="btn-dark" onclick="viewNotifications()" style="margin-left: 1rem;">🔔 УВЕДОМЛЕНИЯ</button>
                    <button class="btn-dark" onclick="viewDailyQuests()" style="margin-left: 1rem;">🎯 ЗАДАНИЯ</button>
                </div>
            `;
        }
        
        function editProfile() {
            const user = appState.currentDarkUser;
            const newAvatar = prompt('Введите эмодзи для аватара:', user.avatar);
            if (newAvatar) user.avatar = newAvatar;
            
            const newBio = prompt('Введите биографию:', user.bio);
            if (newBio !== null) user.bio = newBio;
            
            loadProfile();
            alert('Профиль обновлён!');
        }
        
        function generateUserInvite() {
            const user = appState.currentDarkUser;
            const rank = getUserRank(user.experience);
            
            if (!rank.canInvite) {
                alert('❌ Недостаточно прав');
                return;
            }
            
            if (user.invitesUsed >= rank.maxInvites) {
                alert('❌ Достигнут лимит инвайтов');
                return;
            }
            
            const inviteCode = 'https://invite.to/rp-market/' + Math.random().toString(36).substr(2, 9);
            appState.validInvites.push(inviteCode);
            user.invitesUsed++;
            
            alert(`✅ ИНВАЙТ СОЗДАН!\n\n${inviteCode}\n\nИспользовано: ${user.invitesUsed} / ${rank.maxInvites}`);
            loadProfile();
        }
        
        // Escrow System
        function loadEscrow() {
            if (!appState.escrows) appState.escrows = [];
            
            const escrowList = document.getElementById('escrowList');
            escrowList.innerHTML = '';
            
            const userEscrows = appState.escrows.filter(e => 
                e.seller === appState.currentDarkUser.username || 
                e.buyer === appState.currentDarkUser.username
            );
            
            if (userEscrows.length === 0) {
                escrowList.innerHTML = '<p style="color: var(--light-text); text-align: center;">Нет активных сделок</p>';
                return;
            }
            
            userEscrows.forEach(escrow => {
                const escrowCard = document.createElement('div');
                escrowCard.className = 'item-card';
                escrowCard.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <span class="item-name">Сделка #${escrow.id}</span>
                        <span style="padding: 0.25rem 0.75rem; background: ${escrow.status === 'pending' ? '#f59e0b' : escrow.status === 'confirmed' ? '#10b981' : '#ef4444'}; border-radius: 20px; font-size: 0.85rem;">
                            ${escrow.status === 'pending' ? '⏳ Ожидание' : escrow.status === 'confirmed' ? '✅ Подтверждено' : '🔒 Завершено'}
                        </span>
                    </div>
                    <div style="margin: 0.5rem 0;">💰 Сумма: ${escrow.amount} ₽</div>
                    <div style="margin: 0.5rem 0;">👤 Продавец: ${escrow.seller}</div>
                    <div style="margin: 0.5rem 0;">👤 Покупатель: ${escrow.buyer}</div>
                    <div style="margin: 0.5rem 0;">📝 ${escrow.description}</div>
                    ${escrow.status === 'pending' && escrow.buyer === appState.currentDarkUser.username ? 
                        '<button class="btn-dark" onclick="confirmEscrow(' + escrow.id + ')">✅ ПОДТВЕРДИТЬ ПОЛУЧЕНИЕ</button>' : ''}
                    ${escrow.status === 'confirmed' && escrow.seller === appState.currentDarkUser.username ? 
                        '<button class="btn-dark" onclick="completeEscrow(' + escrow.id + ')">💰 ПОЛУЧИТЬ ДЕНЬГИ</button>' : ''}
                `;
                escrowList.appendChild(escrowCard);
            });
        }
        
        function createEscrow() {
            if (!appState.currentDarkUser) return;
            
            const buyer = document.getElementById('escrowBuyer').value;
            const amount = parseInt(document.getElementById('escrowAmount').value);
            const description = document.getElementById('escrowDescription').value;
            
            if (!buyer || !amount || !description) {
                alert('Заполните все поля');
                return;
            }
            
            if (!appState.darkUsers[buyer]) {
                alert('Покупатель не найден');
                return;
            }
            
            if (!appState.escrows) appState.escrows = [];
            
            const escrow = {
                id: appState.escrows.length + 1,
                seller: appState.currentDarkUser.username,
                buyer: buyer,
                amount: amount,
                description: description,
                status: 'pending',
                created: new Date().toLocaleString('ru-RU')
            };
            
            appState.escrows.push(escrow);
            
            // Clear form
            document.getElementById('escrowBuyer').value = '';
            document.getElementById('escrowAmount').value = '';
            document.getElementById('escrowDescription').value = '';
            
            alert('✅ Безопасная сделка создана!');
            loadEscrow();
        }
        
        function confirmEscrow(id) {
            const escrow = appState.escrows.find(e => e.id === id);
            if (escrow) {
                escrow.status = 'confirmed';
                addNotification('Сделка #' + id + ' подтверждена покупателем');
                alert('✅ Вы подтвердили получение товара!');
                loadEscrow();
            }
        }
        
        function completeEscrow(id) {
            const escrow = appState.escrows.find(e => e.id === id);
            if (escrow) {
                escrow.status = 'completed';
                appState.currentDarkUser.balance += escrow.amount;
                appState.currentDarkUser.deals++;
                addExperience(10, 'Успешная сделка');
                document.getElementById('userBalance').textContent = appState.currentDarkUser.balance;
                alert('✅ Сделка завершена! Деньги получены. +10 опыта');
                loadEscrow();
            }
        }
        
        // Wallet System
        function loadWallet() {
            if (!appState.currentDarkUser) return;
            
            const user = appState.currentDarkUser;
            const walletContent = document.getElementById('walletContent');
            
            const rates = { btc: 4500000, eth: 250000, usdt: 90 };
            
            walletContent.innerHTML = `
                <div style="background: var(--dark-surface); padding: 1.5rem; border-radius: 10px;">
                    <h4 style="color: var(--dark-red); margin-bottom: 1rem;">₿ Bitcoin</h4>
                    <div style="font-size: 2rem; color: var(--dark-red); margin: 1rem 0;">${user.wallets.btc.toFixed(8)} BTC</div>
                    <div style="font-size: 0.9rem; color: var(--light-text);">≈ ${(user.wallets.btc * rates.btc).toFixed(2)} ₽</div>
                    <div style="margin-top: 1rem;">
                        <button class="btn-dark" onclick="depositCrypto('btc')">📥 ПОПОЛНИТЬ</button>
                        <button class="btn-dark" onclick="withdrawCrypto('btc')" style="margin-left: 0.5rem;">📤 ВЫВЕСТИ</button>
                    </div>
                </div>
                
                <div style="background: var(--dark-surface); padding: 1.5rem; border-radius: 10px;">
                    <h4 style="color: var(--dark-red); margin-bottom: 1rem;">Ξ Ethereum</h4>
                    <div style="font-size: 2rem; color: var(--dark-red); margin: 1rem 0;">${user.wallets.eth.toFixed(6)} ETH</div>
                    <div style="font-size: 0.9rem; color: var(--light-text);">≈ ${(user.wallets.eth * rates.eth).toFixed(2)} ₽</div>
                    <div style="margin-top: 1rem;">
                        <button class="btn-dark" onclick="depositCrypto('eth')">📥 ПОПОЛНИТЬ</button>
                        <button class="btn-dark" onclick="withdrawCrypto('eth')" style="margin-left: 0.5rem;">📤 ВЫВЕСТИ</button>
                    </div>
                </div>
                
                <div style="background: var(--dark-surface); padding: 1.5rem; border-radius: 10px;">
                    <h4 style="color: var(--dark-red); margin-bottom: 1rem;">₮ USDT</h4>
                    <div style="font-size: 2rem; color: var(--dark-red); margin: 1rem 0;">${user.wallets.usdt.toFixed(2)} USDT</div>
                    <div style="font-size: 0.9rem; color: var(--light-text);">≈ ${(user.wallets.usdt * rates.usdt).toFixed(2)} ₽</div>
                    <div style="margin-top: 1rem;">
                        <button class="btn-dark" onclick="depositCrypto('usdt')">📥 ПОПОЛНИТЬ</button>
                        <button class="btn-dark" onclick="withdrawCrypto('usdt')" style="margin-left: 0.5rem;">📤 ВЫВЕСТИ</button>
                    </div>
                </div>
            `;
            
            // Load transaction history
            if (!appState.transactions) appState.transactions = [];
            const history = document.getElementById('transactionHistory');
            const userTx = appState.transactions.filter(tx => tx.user === user.username).slice(-20).reverse();
            
            if (userTx.length === 0) {
                history.innerHTML = '<p style="color: var(--light-text);">История пуста</p>';
            } else {
                history.innerHTML = userTx.map(tx => 
                    `<div style="margin: 0.5rem 0; padding: 0.5rem; background: var(--dark-surface); border-radius: 5px;">
                        <div style="display: flex; justify-content: space-between;">
                            <span>${tx.type === 'deposit' ? '📥' : '📤'} ${tx.currency.toUpperCase()}</span>
                            <span style="color: ${tx.type === 'deposit' ? '#10b981' : '#ef4444'};">${tx.type === 'deposit' ? '+' : '-'}${tx.amount}</span>
                        </div>
                        <div style="font-size: 0.85rem; color: var(--light-text);">${tx.time}</div>
                    </div>`
                ).join('');
            }
        }
        
        function depositCrypto(currency) {
            const address = 'bc1q' + Math.random().toString(36).substr(2, 30);
            alert(`📥 ПОПОЛНЕНИЕ ${currency.toUpperCase()}\n\nОтправьте средства на адрес:\n${address}\n\n⚠️ Это демонстрация. В реальности транзакции не происходят.`);
            
            // Simulate deposit
            const amount = parseFloat(prompt('Введите сумму для демонстрации:'));
            if (amount && amount > 0) {
                appState.currentDarkUser.wallets[currency] += amount;
                if (!appState.transactions) appState.transactions = [];
                appState.transactions.push({
                    user: appState.currentDarkUser.username,
                    type: 'deposit',
                    currency: currency,
                    amount: amount,
                    time: new Date().toLocaleString('ru-RU')
                });
                addNotification(`Пополнение ${currency.toUpperCase()}: +${amount}`);
                loadWallet();
            }
        }
        
        function withdrawCrypto(currency) {
            const amount = parseFloat(prompt(`Сумма вывода (${currency.toUpperCase()}):`, '0'));
            if (!amount || amount <= 0) return;
            
            if (appState.currentDarkUser.wallets[currency] < amount) {
                alert('❌ Недостаточно средств');
                return;
            }
            
            const address = prompt('Адрес кошелька:');
            if (!address) return;
            
            appState.currentDarkUser.wallets[currency] -= amount;
            if (!appState.transactions) appState.transactions = [];
            appState.transactions.push({
                user: appState.currentDarkUser.username,
                type: 'withdraw',
                currency: currency,
                amount: amount,
                time: new Date().toLocaleString('ru-RU')
            });
            addNotification(`Вывод ${currency.toUpperCase()}: -${amount}`);
            alert('✅ Заявка на вывод создана!\n\n⚠️ Это демонстрация');
            loadWallet();
        }
        
        // Auctions System
        function loadAuctions() {
            if (!appState.auctions) appState.auctions = [];
            
            const auctionsList = document.getElementById('auctionsList');
            auctionsList.innerHTML = '';
            
            if (appState.auctions.length === 0) {
                auctionsList.innerHTML = '<p style="color: var(--light-text); text-align: center;">Нет активных аукционов</p>';
                return;
            }
            
            appState.auctions.forEach(auction => {
                const timeLeft = Math.max(0, Math.floor((auction.endTime - Date.now()) / 1000));
                const isActive = timeLeft > 0;
                
                const auctionCard = document.createElement('div');
                auctionCard.className = 'item-card';
                auctionCard.innerHTML = `
                    <div class="item-name">${auction.name}</div>
                    <div style="margin: 1rem 0;">
                        <div>Текущая ставка: <span style="color: var(--dark-red); font-size: 1.3rem;">${auction.currentBid} ₽</span></div>
                        <div style="font-size: 0.9rem; color: var(--light-text);">Ставок: ${auction.bids.length}</div>
                        <div style="font-size: 0.9rem; color: var(--light-text);">Лидер: ${auction.leader || 'Нет ставок'}</div>
                    </div>
                    <div style="margin: 1rem 0; padding: 0.75rem; background: ${isActive ? 'var(--dark-bg)' : '#ef4444'}; border-radius: 5px; text-align: center;">
                        ${isActive ? `⏰ Осталось: ${Math.floor(timeLeft / 60)}м ${timeLeft % 60}с` : '🔴 ЗАВЕРШЁН'}
                    </div>
                    ${isActive && auction.seller !== appState.currentDarkUser.username ? 
                        `<input type="number" id="bid${auction.id}" placeholder="Ваша ставка" style="width: 100%; padding: 0.5rem; margin: 0.5rem 0; background: var(--dark-bg); color: white; border: 1px solid var(--dark-border); border-radius: 5px;">
                        <button class="btn-dark" onclick="makeBid(${auction.id})">💰 СДЕЛАТЬ СТАВКУ</button>` : ''}
                `;
                auctionsList.appendChild(auctionCard);
            });
            
            // Update timers
            setTimeout(() => {
                if (document.getElementById('auctionsTab').classList.contains('hidden') === false) {
                    loadAuctions();
                }
            }, 1000);
        }
        
        function createAuction() {
            if (!appState.currentDarkUser) return;
            
            const rank = getUserRank(appState.currentDarkUser.experience);
            if (!rank.canCreate) {
                alert('❌ Недостаточно прав для создания аукциона');
                return;
            }
            
            const name = document.getElementById('auctionName').value;
            const startBid = parseInt(document.getElementById('auctionStart').value);
            const duration = parseInt(document.getElementById('auctionDuration').value);
            
            if (!name || !startBid || !duration) {
                alert('Заполните все поля');
                return;
            }
            
            if (!appState.auctions) appState.auctions = [];
            
            const auction = {
                id: appState.auctions.length + 1,
                name: name,
                seller: appState.currentDarkUser.username,
                startBid: startBid,
                currentBid: startBid,
                bids: [],
                leader: null,
                endTime: Date.now() + (duration * 60 * 1000),
                created: new Date().toLocaleString('ru-RU')
            };
            
            appState.auctions.push(auction);
            
            document.getElementById('auctionName').value = '';
            document.getElementById('auctionStart').value = '';
            document.getElementById('auctionDuration').value = '';
            
            alert('✅ Аукцион создан!');
            loadAuctions();
        }
        
        function makeBid(auctionId) {
            const auction = appState.auctions.find(a => a.id === auctionId);
            if (!auction) return;
            
            const bidAmount = parseInt(document.getElementById('bid' + auctionId).value);
            
            if (!bidAmount || bidAmount <= auction.currentBid) {
                alert('❌ Ставка должна быть выше текущей');
                return;
            }
            
            if (appState.currentDarkUser.balance < bidAmount) {
                alert('❌ Недостаточно средств');
                return;
            }
            
            auction.currentBid = bidAmount;
            auction.leader = appState.currentDarkUser.username;
            auction.bids.push({
                user: appState.currentDarkUser.username,
                amount: bidAmount,
                time: new Date().toLocaleTimeString('ru-RU')
            });
            
            alert('✅ Ставка принята!');
            loadAuctions();
        }
        
        // Forum System
        function loadForum() {
            if (!appState.forumTopics) appState.forumTopics = [];
            
            const forumTopics = document.getElementById('forumTopics');
            forumTopics.innerHTML = '';
            
            if (appState.forumTopics.length === 0) {
                forumTopics.innerHTML = '<p style="color: var(--light-text); text-align: center;">Нет тем для обсуждения</p>';
                return;
            }
            
            appState.forumTopics.forEach(topic => {
                const topicCard = document.createElement('div');
                topicCard.className = 'item-card';
                topicCard.innerHTML = `
                    <div class="item-name">${topic.title}</div>
                    <div style="margin: 1rem 0; font-size: 0.9rem;">${topic.content.substring(0, 200)}${topic.content.length > 200 ? '...' : ''}</div>
                    <div style="display: flex; justify-content: space-between; font-size: 0.85rem; color: var(--light-text);">
                        <span>👤 ${topic.author}</span>
                        <span>💬 Ответов: ${topic.replies ? topic.replies.length : 0}</span>
                        <span>⏰ ${topic.time}</span>
                    </div>
                    <button class="btn-dark" onclick="viewTopic(${topic.id})" style="margin-top: 1rem;">📖 ОТКРЫТЬ</button>
                `;
                forumTopics.appendChild(topicCard);
            });
        }
        
        function createTopic() {
            if (!appState.currentDarkUser) return;
            
            const title = document.getElementById('topicTitle').value;
            const content = document.getElementById('topicContent').value;
            
            if (!title || !content) {
                alert('Заполните все поля');
                return;
            }
            
            if (!appState.forumTopics) appState.forumTopics = [];
            
            const topic = {
                id: appState.forumTopics.length + 1,
                title: title,
                content: content,
                author: appState.currentDarkUser.username,
                time: new Date().toLocaleString('ru-RU'),
                replies: []
            };
            
            appState.forumTopics.push(topic);
            
            document.getElementById('topicTitle').value = '';
            document.getElementById('topicContent').value = '';
            
            alert('✅ Тема создана!');
            loadForum();
        }
        
        function viewTopic(topicId) {
            const topic = appState.forumTopics.find(t => t.id === topicId);
            if (!topic) return;
            
            let repliesHtml = topic.replies.map(r => 
                `<div style="background: var(--dark-surface); padding: 1rem; margin: 0.5rem 0; border-radius: 5px; border-left: 3px solid var(--dark-red);">
                    <div style="color: var(--dark-red); font-weight: bold;">${r.author}</div>
                    <div style="margin: 0.5rem 0;">${r.content}</div>
                    <div style="font-size: 0.8rem; color: var(--light-text);">${r.time}</div>
                </div>`
            ).join('');
            
            alert(`${topic.title}\n\nАвтор: ${topic.author}\nВремя: ${topic.time}\n\n${topic.content}\n\nОтветов: ${topic.replies.length}\n\n(Функция ответов будет добавлена)`);
        }
        
        // Admin Panel Enhanced Functions
        function searchUsers() {
            const search = document.getElementById('adminUserSearch').value.toLowerCase();
            const usersList = document.getElementById('usersList');
            usersList.innerHTML = '';
            
            Object.values(appState.darkUsers).filter(u => 
                u.username.toLowerCase().includes(search)
            ).forEach(user => {
                const userDiv = document.createElement('div');
                userDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; padding: 0.5rem; background: var(--dark-surface); border-radius: 5px;';
                const rank = getUserRank(user.experience);
                userDiv.innerHTML = `
                    <div>
                        <div>${rank.emoji} ${user.username} (${user.balance}₽)</div>
                        <div style="font-size: 0.8rem; color: var(--light-text);">Опыт: ${user.experience} | Сделок: ${user.deals}</div>
                    </div>
                    <div>
                        <button class="btn-dark" onclick="editUserAdmin('${user.username}')" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">✏️</button>
                        <button class="delete-btn" onclick="deleteUser('${user.username}')" style="padding: 0.25rem 0.5rem; font-size: 0.8rem; margin-left: 0.5rem;">X</button>
                    </div>
                `;
                usersList.appendChild(userDiv);
            });
        }
        
        function editUserAdmin(username) {
            const user = appState.darkUsers[username];
            if (!user) return;
            
            const newBalance = prompt('Новый баланс:', user.balance);
            if (newBalance !== null) user.balance = parseInt(newBalance);
            
            const newExp = prompt('Новый опыт:', user.experience);
            if (newExp !== null) user.experience = parseInt(newExp);
            
            alert('Пользователь обновлён!');
            loadAdminPanel();
        }
        
        function generateInvite() {
            const code = 'https://invite.to/rp-market/admin_' + Math.random().toString(36).substr(2, 9);
            appState.validInvites.push(code);
            alert(`✅ ИНВАЙТ СОЗДАН (админ):\n\n${code}`);
        }
        
        function saveSettings() {
            alert('⚠️ Настройки сохранены!\n\n(В реальном приложении изменения применились бы)');
        }
        
        function exportLogs() {
            let logs = 'ЛОГИ ПЛОЩАДКИ\n\n';
            logs += 'Пользователей: ' + Object.keys(appState.darkUsers).length + '\n';
            logs += 'Товаров: ' + appState.darkItems.length + '\n';
            logs += 'Сообщений: ' + appState.chatMessages.length + '\n\n';
            logs += '--- ИСТОРИЯ ВХОДОВ ---\n';
            Object.values(appState.darkUsers).forEach(u => {
                if (u.loginHistory && u.loginHistory.length > 0) {
                    logs += u.username + ': ' + u.loginHistory.length + ' входов\n';
                }
            });
            
            alert('📥 ЭКСПОРТ ЛОГОВ\n\n' + logs);
        }
        
        function deleteItem(itemId) {
            if (confirm('Удалить этот товар?')) {
                appState.darkItems = appState.darkItems.filter(item => item.id !== itemId);
                loadMyItems();
                loadDarkItems();
                alert('Товар удалён!');
            }
        }
        
        function editItem(itemId) {
            alert('Функция редактирования будет добавлена в следующем обновлении');
        }

        // Dark Web Effects
        function startDarkWebEffects() {
            if (appState.isDarkMode) {
                // Random freeze effects
                setInterval(() => {
                    if (appState.isDarkMode && Math.random() < 0.15) {
                        addFreezeEffect();
                    }
                }, 3000);
            }
        }

        function addFreezeEffect() {
            document.body.classList.add('freeze');
            setTimeout(() => {
                document.body.classList.remove('freeze');
            }, 1500);
        }

        function addGlitchEffect() {
            document.getElementById('darkMarket').classList.add('glitch');
            setTimeout(() => {
                document.getElementById('darkMarket').classList.remove('glitch');
            }, 300);
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }

        // Admin Panel functions
        function loadAdminPanel() {
            if (!appState.currentDarkUser || appState.currentDarkUser.role !== 'darkweb_admin') {
                alert('Нет доступа!');
                return;
            }
            
            updateAdminStats();
            loadAdminUsers();
            loadAdminItems();
            loadAdminGangs();
            loadAdminEscrow();
            loadAdminLogs();
            loadAdminAnalytics();
        }
        
        function loadAdminEscrow() {
            if (!appState.escrows) return;
            
            const escrowList = document.getElementById('adminEscrowList');
            escrowList.innerHTML = '';
            
            appState.escrows.filter(e => e.status !== 'completed').forEach(escrow => {
                const escrowDiv = document.createElement('div');
                escrowDiv.style.cssText = 'margin-bottom: 0.5rem; padding: 0.5rem; background: var(--dark-surface); border-radius: 5px;';
                escrowDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div>Сделка #${escrow.id}: ${escrow.amount}₽</div>
                            <div style="font-size: 0.8rem; color: var(--light-text);">${escrow.seller} → ${escrow.buyer}</div>
                        </div>
                        <button class="btn-dark" onclick="resolveDispute(${escrow.id})" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">✓ РЕШИТЬ</button>
                    </div>
                `;
                escrowList.appendChild(escrowDiv);
            });
            
            if (escrowList.children.length === 0) {
                escrowList.innerHTML = '<p style="color: var(--light-text); font-size: 0.85rem;">Нет активных споров</p>';
            }
        }
        
        function resolveDispute(escrowId) {
            const action = confirm('Вернуть деньги покупателю? (OK = да, Отмена = продавцу)');
            const escrow = appState.escrows.find(e => e.id === escrowId);
            if (!escrow) return;
            
            if (action) {
                // Refund buyer
                if (appState.darkUsers[escrow.buyer]) {
                    appState.darkUsers[escrow.buyer].balance += escrow.amount;
                }
                alert('✅ Средства возвращены покупателю');
            } else {
                // Pay seller
                if (appState.darkUsers[escrow.seller]) {
                    appState.darkUsers[escrow.seller].balance += escrow.amount;
                }
                alert('✅ Средства переведены продавцу');
            }
            
            escrow.status = 'completed';
            loadAdminPanel();
        }
        
        function loadAdminLogs() {
            const logsList = document.getElementById('adminLogs');
            logsList.innerHTML = '';
            
            const allLogs = [];
            Object.values(appState.darkUsers).forEach(user => {
                if (user.loginHistory && user.loginHistory.length > 0) {
                    user.loginHistory.slice(-5).forEach(log => {
                        allLogs.push({
                            user: user.username,
                            time: log.time,
                            ip: log.ip,
                            device: log.device
                        });
                    });
                }
            });
            
            allLogs.sort((a, b) => new Date(b.time) - new Date(a.time));
            
            allLogs.slice(0, 20).forEach(log => {
                const logDiv = document.createElement('div');
                logDiv.style.cssText = 'margin-bottom: 0.25rem; padding: 0.25rem; background: var(--dark-surface); border-radius: 3px;';
                logDiv.innerHTML = `<span style="color: var(--dark-red);">${log.user}</span> | ${log.time} | ${log.ip}`;
                logsList.appendChild(logDiv);
            });
            
            if (allLogs.length === 0) {
                logsList.innerHTML = '<p style="color: var(--light-text);">Нет логов</p>';
            }
        }
        
        function loadAdminAnalytics() {
            const analytics = document.getElementById('adminAnalytics');
            
            // Calculate stats
            const totalBalance = Object.values(appState.darkUsers).reduce((sum, u) => sum + (u.balance || 0), 0);
            const avgBalance = totalBalance / Object.keys(appState.darkUsers).length;
            const totalExp = Object.values(appState.darkUsers).reduce((sum, u) => sum + (u.experience || 0), 0);
            const totalDeals = Object.values(appState.darkUsers).reduce((sum, u) => sum + (u.deals || 0), 0);
            
            // Rank distribution
            const rankDist = {};
            appState.ranks.forEach(r => rankDist[r.name] = 0);
            Object.values(appState.darkUsers).forEach(u => {
                const rank = getUserRank(u.experience || 0);
                rankDist[rank.name]++;
            });
            
            analytics.innerHTML = `
                <div style="margin-bottom: 0.5rem;">💰 Средний баланс: ${Math.floor(avgBalance)}₽</div>
                <div style="margin-bottom: 0.5rem;">📊 Всего опыта: ${totalExp}</div>
                <div style="margin-bottom: 0.5rem;">🤝 Всего сделок: ${totalDeals}</div>
                <div style="margin-top: 1rem; font-size: 0.9rem; color: var(--light-text);">
                    <div style="font-weight: bold; margin-bottom: 0.5rem;">Распределение по рангам:</div>
                    ${Object.entries(rankDist).map(([name, count]) => 
                        `<div style="margin: 0.25rem 0;">${name}: ${count} чел.</div>`
                    ).join('')}
                </div>
            `;
            
            // Update totals
            document.getElementById('totalBalance').textContent = totalBalance;
            document.getElementById('totalTransactions').textContent = (appState.transactions || []).length;
        }
        
        function updateAdminStats() {
            document.getElementById('totalUsers').textContent = Object.keys(appState.darkUsers).length;
            document.getElementById('totalItems').textContent = appState.darkItems.length;
            document.getElementById('totalGangs').textContent = appState.gangs.length;
            document.getElementById('totalMessages').textContent = appState.chatMessages.length;
        }
        
        function loadAdminUsers() {
            const usersList = document.getElementById('usersList');
            usersList.innerHTML = '';
            
            Object.values(appState.darkUsers).forEach(user => {
                const userDiv = document.createElement('div');
                userDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; padding: 0.5rem; background: var(--dark-surface); border-radius: 5px;';
                userDiv.innerHTML = `
                    <span>${user.username} (баланс: ${user.balance}₽)</span>
                    <button class="delete-btn" onclick="deleteUser('${user.username}')">X</button>
                `;
                usersList.appendChild(userDiv);
            });
        }
        
        function loadAdminItems() {
            const itemsList = document.getElementById('adminItemsList');
            itemsList.innerHTML = '';
            
            appState.darkItems.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; padding: 0.5rem; background: var(--dark-surface); border-radius: 5px;';
                itemDiv.innerHTML = `
                    <span>${item.name} (${item.seller})</span>
                    <button class="delete-btn" onclick="adminDeleteItem(${item.id})">X</button>
                `;
                itemsList.appendChild(itemDiv);
            });
        }
        
        function loadAdminGangs() {
            const gangsList = document.getElementById('adminGangsList');
            gangsList.innerHTML = '';
            
            appState.gangs.forEach(gang => {
                const gangDiv = document.createElement('div');
                gangDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; padding: 0.5rem; background: var(--dark-surface); border-radius: 5px;';
                gangDiv.innerHTML = `
                    <span>${gang.name} (участников: ${gang.members})</span>
                    <button class="delete-btn" onclick="deleteGang(${gang.id})">X</button>
                `;
                gangsList.appendChild(gangDiv);
            });
        }
        
        function deleteUser(username) {
            if (confirm(`Удалить пользователя ${username}?`)) {
                delete appState.darkUsers[username];
                loadAdminUsers();
                updateAdminStats();
                alert('Пользователь удалён!');
            }
        }
        
        function adminDeleteItem(itemId) {
            if (confirm('Удалить этот товар?')) {
                appState.darkItems = appState.darkItems.filter(item => item.id !== itemId);
                loadAdminItems();
                loadDarkItems();
                updateAdminStats();
                alert('Товар удалён!');
            }
        }
        
        function deleteGang(gangId) {
            if (confirm('Удалить эту группировку?')) {
                appState.gangs = appState.gangs.filter(gang => gang.id !== gangId);
                loadAdminGangs();
                loadGangs();
                updateAdminStats();
                alert('Группировка удалена!');
            }
        }
        
        function clearAllData() {
            if (confirm('Удалить ВСЕ данные? Это действие нельзя отменить!')) {
                appState.darkUsers = {};
                appState.darkItems = [];
                appState.gangs = [];
                appState.chatMessages = [];
                loadAdminPanel();
                alert('Все данные очищены!');
            }
        }
        
        function resetSystem() {
            if (confirm('Сбросить систему до начального состояния?')) {
                location.reload();
            }
        }

        // Auto-save reminder
        setInterval(() => {
            if (appState.isDarkMode && Math.random() < 0.1) {
                addNotification('⚡ Система работает стабильно');
            }
        }, 60000);
        
        // Daily Quests System
        function checkDailyQuests() {
            if (!appState.currentDarkUser) return;
            
            if (!appState.currentDarkUser.quests) {
                appState.currentDarkUser.quests = {
                    daily: [
                        { id: 1, name: 'Совершите 1 сделку', progress: 0, target: 1, reward: 15, completed: false },
                        { id: 2, name: 'Отправьте 5 сообщений', progress: 0, target: 5, reward: 10, completed: false },
                        { id: 3, name: 'Посетите все вкладки', progress: 0, target: 1, reward: 5, completed: false }
                    ],
                    lastReset: new Date().toDateString()
                };
            }
            
            // Reset daily quests if it's a new day
            const today = new Date().toDateString();
            if (appState.currentDarkUser.quests.lastReset !== today) {
                appState.currentDarkUser.quests.daily.forEach(q => {
                    q.progress = 0;
                    q.completed = false;
                });
                appState.currentDarkUser.quests.lastReset = today;
            }
        }
        
        function viewDailyQuests() {
            checkDailyQuests();
            if (!appState.currentDarkUser) return;
            
            let questText = '🎯 ЕЖЕДНЕВНЫЕ ЗАДАНИЯ\n\n';
            
            appState.currentDarkUser.quests.daily.forEach(q => {
                questText += `${q.completed ? '✅' : '🔴'} ${q.name}\n`;
                questText += `   Прогресс: ${q.progress}/${q.target}\n`;
                questText += `   Награда: +${q.reward} опыта\n\n`;
            });
            
            alert(questText);
        }
        
        // Check for idle
        let lastActivity = Date.now();
        let idleCheckInterval;
        
        document.addEventListener('mousemove', () => lastActivity = Date.now());
        document.addEventListener('keypress', () => lastActivity = Date.now());
        
        function checkIdle() {
            if (appState.isDarkMode && Date.now() - lastActivity > 1800000) { // 30 min
                alert('⚠️ АВТОМАТИЧЕСКИЙ ВЫХОД\n\nСеанс завершён из-за неактивности (30 мин)');
                exitDarkMarket();
            }
        }
        
        setInterval(checkIdle, 60000); // Check every minute
        
        // Show daily quests notification on login
        function showWelcomeMessage() {
            if (appState.currentDarkUser) {
                checkDailyQuests();
                const rank = getUserRank(appState.currentDarkUser.experience);
                setTimeout(() => {
                    const incomplete = appState.currentDarkUser.quests.daily.filter(q => !q.completed).length;
                    if (incomplete > 0) {
                        addNotification(`🎯 У вас ${incomplete} незавершённых заданий`);
                    }
                }, 2000);
            }
        }
    </script>
</body>
</html>
